<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Final Smashers - Cosmic Impact Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

    body {
      font-family: 'Orbitron', sans-serif;
      background: radial-gradient(ellipse at bottom, #050e26 0%, #000014 100%);
      color: #cbd5e1;
      min-height: 100vh;
      margin: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a:focus-visible, button:focus-visible {
      outline: 2px solid #56d9f9;
      outline-offset: 2px;
    }

    .nav-link:hover {
      color: #56d9f9;
    }

    .text-glow {
      text-shadow: 0 0 6px #56d9f9;
    }

    .rounded-container {
      border-radius: 1rem;
      border: 1px solid #1e293b;
      background-color: rgba(8, 19, 42, 0.65);
      box-shadow: 0 0 15px rgb(8 25 56 / 0.75);
    }

    .learn-more-btn {
      background-color: #0a143e;
      padding: 0.5rem 1.75rem;
      border-radius: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      color: white; /* Ensure text color is white */
      border: none; /* Ensure no default button border */
    }
    .learn-more-btn:hover {
      background-color: #1e40af;
      box-shadow: 0 0 10px #3b82f6;
    }

    .card {
      border-radius: 0.75rem;
      background-color: rgba(11, 23, 50, 0.45);
      border: 1px solid #2c3b62;
      box-shadow: 0 0 10px rgb(58 73 121 / 0.6);
      transition: transform 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 30px #3b82f6;
    }

    .scroll-hide::-webkit-scrollbar {
      display: none;
    }
    .scroll-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    img {
      background-color: #14213d;
      border-radius: 0.75rem;
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
    }

    /* Hide the second and third pages initially - this is the original behavior */
    #second-page,
    #third-page {
      display: none;
    }

    /* === NEW ASTEROID UNDER STUDY STYLES === */
    .new-asteroid-container {
      display: flex; /* Default display for this section */
      padding: 2rem 4rem;
      align-items: center;
      gap: 3rem;
      background-color: #091026;
      border-radius: 1rem;
      margin: 2rem 6rem;
      box-shadow: 0 0 20px rgba(255, 187, 51, 0.6);
      color: #ffbb33;
    }

    .new-asteroid-content {
      flex: 1;
    }

    .new-asteroid-content h1 {
      font-size: 3rem;
      font-weight: 900;
      letter-spacing: 2px;
      margin: 0 0 1rem 0;
      line-height: 1.1;
    }

    .new-asteroid-content h1 span {
      color: #f0f0f0;
    }

    .asteroid-id {
      font-weight: 700;
      font-size: 1.5rem;
      color: #a0e7e5;
      margin-bottom: 1rem;
    }

    .details p {
      font-size: 1.1rem;
      color: #a0e7e5;
      margin: 0.35rem 0;
    }

    .details p span {
      color: #f0f0f0;
      font-weight: 600;
    }

    .image-container {
      width: 300px;
      height: 300px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(255, 187, 51, 0.5);
      background-color: #000;
      flex-shrink: 0;
    }

    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    @media (max-width: 768px) {
      .new-asteroid-container {
        flex-direction: column;
        padding: 2rem;
        margin: 2rem;
      }
      .image-container {
        width: 100%;
        height: 200px;
      }
    }

    /* === HOVER OVERLAY ON SECOND PAGE CARDS === */
    .card-image-wrapper {
      position: relative;
      width: 100%;
      border-radius: 0.75rem;
      overflow: hidden;
    }

    .card-hover-overlay {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background-color: rgba(20, 30, 60, 0.65);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 0.75rem;
      pointer-events: none;
    }

    .card:hover .card-hover-overlay {
      opacity: 1;
      pointer-events: auto;
    }

    .card-hover-btn {
      background-color: #3b82f6;
      color: white;
      font-weight: 600;
      padding: 0.5rem 1.5rem;
      border-radius: 1.5rem;
      box-shadow: 0 4px 8px rgba(59,130,246,0.6);
      cursor: pointer;
      font-size: 1rem;
      user-select: none;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      border: none;
    }
    .card-hover-btn:hover,
    .card-hover-btn:focus-visible {
      background-color: #2563eb;
      box-shadow: 0 6px 12px rgba(37,99,235,0.8);
      outline: none;
    }

    /* === THIRD PAGE STYLES === */
    #third-page {
      max-width: 1200px;
      margin: 2rem auto 4rem;
      padding: 2rem;
      /* This will be controlled by JS, so default to hidden */
      /* display: flex; */ /* Removed default flex to ensure JS controls it */
      align-items: center;
      gap: 4rem;
      color: white;
      border-radius: 1rem;
      background: rgba(5, 14, 38, 0.85);
      box-shadow: 0 0 20px #3b82f6;
      flex-wrap: wrap;
    }
    #third-page img {
      flex-shrink: 0;
      width: 400px;
      max-width: 100%;
      border-radius: 1rem;
      box-shadow: 0 0 25px #0ea5e9;
      background-color: #000;
    }
    #third-page-content {
      flex: 1 1 400px;
    }
    #third-page-content h1 {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 1rem;
      line-height: 1.1;
    }
    #third-page-content h1 span {
      color: #fbbf24;
    }
    #third-page-content p {
      font-size: 1.2rem;
      line-height: 1.6;
      color: #d1d5db;
      white-space: pre-line; /* This is important for preserving newlines */
    }

    #third-page .back-btn {
      margin-top: 2rem;
      background-color: #3b82f6;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 2rem;
      color: white;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      box-shadow: 0 0 10px #3b82f6;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    #third-page .back-btn:hover,
    #third-page .back-btn:focus-visible {
      background-color: #2563eb;
      box-shadow: 0 0 15px #2563eb;
      outline: none;
    }

    /* Responsive third page */
    @media (max-width: 768px) {
      #third-page {
        flex-direction: column;
        padding: 1rem;
        margin: 1rem;
      }
      #third-page img {
        width: 100%;
        margin-bottom: 1.5rem;
      }
      #third-page-content h1 {
        font-size: 2.5rem;
      }
    }

    /* === CHATBOT STYLES === */
    #chatbot-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #56d9f9;
      color: #000014;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(86, 217, 249, 0.7);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      z-index: 1000;
      /* Add jump animation */
      animation: jump 2s infinite ease-in-out;
    }
    #chatbot-btn:hover {
      background-color: #3b82f6;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.9);
    }

    /* Keyframe animation for jumping effect */
    @keyframes jump {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px); /* Adjust how high it jumps */
      }
    }

    #chatbot-modal {
      display: none; /* Corrected: Should start hidden */
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 320px;
      height: 450px;
      background: rgba(8, 19, 42, 0.95);
      border: 1px solid #1e293b;
      border-radius: 1rem;
      box-shadow: 0 0 25px rgba(86, 217, 249, 0.5);
      z-index: 999;
      flex-direction: column;
      overflow: hidden;
    }
    #chatbot-header {
      background: #0a143e;
      color: #56d9f9;
      padding: 12px;
      border-bottom: 1px solid #1e293b;
      text-align: center;
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 0.05em;
    }
    #chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 15px;
      color: #cbd5e1;
      font-size: 0.95rem;
      line-height: 1.4;
      scrollbar-width: thin;
      scrollbar-color: #3b82f6 #0a143e;
    }
    #chat-messages::-webkit-scrollbar {
      width: 8px;
    }
    #chat-messages::-webkit-scrollbar-track {
      background: #0a143e;
    }
    #chat-messages::-webkit-scrollbar-thumb {
      background-color: #3b82f6;
      border-radius: 10px;
      border: 2px solid #0a143e;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 0.75rem;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user {
      background: #1e40af;
      color: white;
      margin-left: auto;
      text-align: right;
    }
    .bot {
      background: #050e26;
      border: 1px solid #1e293b;
      color: #cbd5e1;
      margin-right: auto;
      text-align: left;
    }
    #chat-input-container {
      display: flex;
      border-top: 1px solid #1e293b;
      background-color: #0a143e;
    }
    #chat-input {
      flex-grow: 1;
      padding: 12px 15px;
      border: none;
      background: transparent;
      color: #cbd5e1;
      font-size: 1rem;
    }
    #chat-input:focus {
      outline: none;
    }
    #chat-input::placeholder {
      color: #64748b;
    }
    #chat-send-btn {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 0 15px;
      border-radius: 0 0 0.75rem 0;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #chat-send-btn:hover {
      background-color: #2563eb;
    }

    /* Additional responsive adjustments for second page cards */
    @media (max-width: 768px) {
      #second-page-cards {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Adjust for smaller screens */
      }
    }

    /* === GATE STYLES === */
    #gate-modal {
      display: none; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000; /* Above everything else */
      justify-content: center;
      align-items: center;
    }

    #gate-content {
      background: rgba(8, 19, 42, 0.95);
      border: 1px solid #1e293b;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 0 30px rgba(86, 217, 249, 0.7);
      width: 90%;
      max-width: 450px;
      text-align: center;
      position: relative;
    }

    #gate-content h2 {
      font-size: 2rem;
      font-weight: 700;
      color: #56d9f9;
      margin-bottom: 1.5rem;
    }

    #gate-content input[type="text"],
    #gate-content input[type="password"],
    #gate-content select {
      width: calc(100% - 24px); /* Account for padding */
      padding: 12px;
      margin-bottom: 1rem;
      border: 1px solid #2c3b62;
      border-radius: 0.5rem;
      background-color: #050e26;
      color: #cbd5e1;
      font-size: 1rem;
    }

    #gate-content input[type="text"]:focus,
    #gate-content input[type="password"]:focus,
    #gate-content select:focus {
      outline: none;
      border-color: #56d9f9;
      box-shadow: 0 0 8px rgba(86, 217, 249, 0.5);
    }

    #gate-content button {
      width: 100%;
      padding: 12px;
      border-radius: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      margin-top: 0.5rem;
    }

    #gate-content .primary-btn {
      background-color: #3b82f6;
      color: white;
      box-shadow: 0 0 10px #3b82f6;
    }
    #gate-content .primary-btn:hover {
      background-color: #2563eb;
      box-shadow: 0 0 15px #2563eb;
    }

    #gate-content .secondary-btn {
      background-color: #0a143e;
      color: #56d9f9;
      border: 1px solid #56d9f9;
      margin-top: 1rem;
    }
    #gate-content .secondary-btn:hover {
      background-color: #1e40af;
      box-shadow: 0 0 10px #56d9f9;
    }

    #gate-message {
      color: #ef4444; /* Red for errors */
      margin-top: 1rem;
      min-height: 1.5rem;
    }

    #login-toggle-btn, #signup-toggle-btn {
        background: none;
        border: none;
        color: #56d9f9;
        text-decoration: underline;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 1rem;
    }
    #login-toggle-btn:hover, #signup-toggle-btn:hover {
        color: #3b82f6;
    }

    /* Hide main content until logged in */
    body.logged-out #main-content-wrapper {
        display: none;
    }
    body.logged-out #chatbot-btn {
        display: none; /* Hide chatbot if not logged in */
    }

    /* Header elements for logged in state */
    #user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #cbd5e1;
        font-weight: 600;
    }
    #logout-btn {
        background-color: #ef4444; /* Red logout button */
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 700;
        transition: background-color 0.3s ease;
    }
    #logout-btn:hover {
        background-color: #dc2626;
    }
    #login-signup-btn {
        background-color: #56d9f9;
        color: #000014;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 700;
        transition: background-color 0.3s ease;
    }
    #login-signup-btn:hover {
        background-color: #3b82f6;
    }

    /* Scientist exclusive content */
    #scientist-exclusive-content {
        display: none; /* Hidden by default, JS will show if scientist is logged in */
        background-color: rgba(11, 23, 50, 0.6);
        border: 1px solid #2c3b62;
        border-radius: 1rem;
        margin: 2rem 6rem;
        padding: 2rem;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
        color: #a0e7e5;
        text-align: center;
    }

    #scientist-exclusive-content h2 {
        font-size: 2.5rem;
        color: #56d9f9;
        margin-bottom: 1rem;
    }
    #scientist-exclusive-content p {
        font-size: 1.1rem;
        line-height: 1.6;
    }

    /* === EARTH PLANET EYE STYLES === */
    #earth-container {
      position: relative;
      width: 100px; /* Size of the Earth */
      height: 100px;
      margin: 0 auto 1.5rem auto; /* Center and add space below */
      border-radius: 50%;
      overflow: hidden; /* Crucial for containing the eyelid */
      box-shadow: 0 0 15px rgba(86, 217, 249, 0.5);
      background-color: #000; /* Fallback if image fails */
    }

    #earth-planet {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      display: block;
    }

    #earth-eyelid {
      position: absolute;
      top: 0; /* Start at the top of the planet */
      left: 0;
      width: 100%;
      height: 100%; /* Covers the whole planet initially */
      background: radial-gradient(circle at 50% 20%, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.5) 50%, transparent 70%); /* Simulates a dark crescent */
      /* Or use an image: */
      /* background-image: url('https://example.com/path/to/your/crescent-eyelid.png'); */
      /* background-size: cover; */
      /* background-position: center; */
      border-radius: 50%;
      transform: translateY(-100%); /* Start completely above the planet */
      transition: transform 0.3s ease-out; /* Smooth transition */
      pointer-events: none; /* Don't block clicks on the planet */
    }

    #earth-eyelid.password-active {
      transform: translateY(0%); /* Move down to cover the planet */
    }

    /* Styles for the new header buttons */
    .header-btn {
      background-color: #0a143e;
      color: #56d9f9;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
      cursor: pointer;
      border: 1px solid #1e293b;
      white-space: nowrap; /* Prevent text wrapping */
    }
    .header-btn:hover {
      background-color: #1e40af;
      color: white;
      box-shadow: 0 0 10px #3b82f6;
    }
    .header-btn:focus-visible {
      outline: 2px solid #56d9f9;
      outline-offset: 2px;
    }

    /* Simulation Tool Styles */
    #simulation-tool {
      display: none; /* Hidden by default */
      max-width: 1200px;
      margin: 2rem auto 4rem;
      padding: 2rem;
      background: rgba(5, 14, 38, 0.85);
      border-radius: 1rem;
      box-shadow: 0 0 20px #56d9f9;
      color: white;
      text-align: center;
    }

    #simulation-tool h2 {
      font-size: 2.5rem;
      color: #56d9f9;
      margin-bottom: 1.5rem;
    }

    #simulation-tool .input-group {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #simulation-tool label {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      color: #a0e7e5;
    }

    #simulation-tool input[type="number"],
    #simulation-tool select {
      width: 80%;
      max-width: 300px;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #2c3b62;
      background-color: #050e26;
      color: #cbd5e1;
      font-size: 1rem;
    }

    #simulation-tool button {
      margin-top: 1.5rem;
      background-color: #3b82f6;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      box-shadow: 0 0 10px #3b82f6;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    #simulation-tool button:hover {
      background-color: #2563eb;
      box-shadow: 0 0 15px #2563eb;
    }

    #simulation-results {
      margin-top: 2rem;
      padding: 1.5rem;
      background-color: rgba(11, 23, 50, 0.6);
      border-radius: 0.75rem;
      border: 1px solid #2c3b62;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
      text-align: left;
    }

    #simulation-results h3 {
      font-size: 1.8rem;
      color: #56d9f9;
      margin-bottom: 1rem;
    }

    #simulation-results p {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    #simulation-results p span {
      font-weight: 600;
      color: #fbbf24;
    }

    /* Styles from kkkk.html */
    #asteroid-map-section {
        display: none; /* Hidden by default */
        flex-direction: column;
        height: calc(100vh - 80px); /* Adjust based on header/footer height */
        width: 100%;
    }
    #asteroid-map-section .asteroid-map-header { /* Changed to avoid conflict with main header */
        background: rgba(8, 19, 42, 0.65);
        padding: 1rem;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #1e293b;
        z-index: 20;
    }
    #asteroid-map-section .asteroid-map-header h1 { /* Changed to avoid conflict with main h1 */
        font-size: 1.5rem;
        background: linear-gradient(90deg, #56d9f9, #a66fff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        user-select: none;
        text-shadow: 0 0 6px #56d9f9;
    }
    #asteroid-map-section .controls {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    #asteroid-map-section label {
        color: #a0e7e5;
        font-size: 0.9rem;
    }
    #asteroid-map-section input[type="date"], #asteroid-map-section select {
        background: rgba(11, 23, 50, 0.45);
        border: 1px solid #2c3b62;
        border-radius: 0.5rem;
        color: #cbd5e1;
        padding: 0.4rem 0.6rem;
        font-size: 0.9rem;
    }
    #asteroid-map-section .map-button { /* Changed to avoid conflict with main buttons */
      background-color: #0a143e;
      border: none;
      border-radius: 0.5rem;
      color: white;
      padding: 0.5rem 1.75rem;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    #asteroid-map-section .map-button:hover {
        background-color: #1e40af;
        box-shadow: 0 0 10px #3b82f6;
    }
    #asteroid-map-section .map-button:focus-visible {
        outline: 2px solid #56d9f9;
        outline-offset: 2px;
    }
    #asteroid-map-section #map-container { /* Changed ID to avoid conflict */
        flex: 1;
        position: relative;
    }
    #asteroid-map-section #asteroid-map-scene-container { /* Changed ID to avoid conflict */
        width: 100%;
        height: 100%;
        display: block;
    }
    #asteroid-map-section #asteroid-map-info-panel { /* Changed ID to avoid conflict */
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 320px;
        max-width: 90vw;
        background: rgba(8, 19, 42, 0.9);
        border: 1px solid #1e293b;
        border-radius: 1rem;
        padding: 1rem;
        color: #cbd5e1;
        font-size: 0.9rem;
        display: none;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 20px rgba(0,0,0,0.7);
        z-index: 30;
    }
    #asteroid-map-section #asteroid-map-info-panel h2 {
        color: #56d9f9;
        margin-bottom: 0.5rem;
        font-size: 1.2rem;
        border-bottom: 1px solid #1e293b;
        padding-bottom: 0.5rem;
        text-shadow: 0 0 6px #56d9f9;
    }
    #asteroid-map-section .info-item {
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
    }
    #asteroid-map-section .info-label {
        font-weight: 600;
        color: #a0e7e5;
    }
    #asteroid-map-section .info-value a {
        color: #56d9f9;
        text-decoration: none;
    }
    #asteroid-map-section .info-value a:hover {
        text-decoration: underline;
    }
    #asteroid-map-section #asteroid-map-close-info {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: #a0e7e5;
        font-size: 1.4rem;
        cursor: pointer;
        padding: 0;
        width: 28px;
        height: 28px;
        line-height: 28px;
        text-align: center;
    }
    #asteroid-map-section #asteroid-map-loading, #asteroid-map-section #asteroid-map-error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(8, 19, 42, 0.95);
        padding: 1.5rem 2rem;
        border-radius: 1rem;
        border: 1px solid #1e293b;
        text-align: center;
        z-index: 40;
        display: none;
        max-width: 90vw;
    }
    #asteroid-map-section #asteroid-map-loading .spinner {
        border: 3px solid rgba(86, 217, 249, 0.3);
        border-radius: 50%;
        border-top: 3px solid #56d9f9;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    #asteroid-map-section @keyframes spin {
        0% { transform: rotate(0deg);}
        100% { transform: rotate(360deg);}
    }
    #asteroid-map-section #asteroid-map-error-message .map-button { /* Changed to avoid conflict */
        margin-top: 1rem;
        background-color: #0a143e;
        border: none;
        padding: 0.5rem 1.75rem;
        border-radius: 0.5rem;
        color: white;
        cursor: pointer;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }
    #asteroid-map-section #asteroid-map-error-message .map-button:hover { /* Changed to avoid conflict */
        background-color: #1e40af;
        box-shadow: 0 0 10px #3b82f6;
    }
    #asteroid-map-section .asteroid-map-footer { /* Changed to avoid conflict with main footer */
        padding: 0.5rem;
        text-align: center;
        font-size: 0.8rem;
        color: #6a7a9a;
        background: rgba(8, 19, 42, 0.8);
        border-top: 1px solid #1e293b;
        user-select: none;
    }
    /* Zoom and rotate buttons container */
    #asteroid-map-section #asteroid-map-ui-buttons { /* Changed ID to avoid conflict */
        position: absolute;
        top: 1rem;
        left: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 25;
    }
    #asteroid-map-section #asteroid-map-ui-buttons .map-button { /* Changed to avoid conflict */
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
        line-height: 1;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #0a143e;
        border-radius: 0.5rem;
        color: white;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    #asteroid-map-section #asteroid-map-ui-buttons .map-button:hover { /* Changed to avoid conflict */
        background-color: #1e40af;
        box-shadow: 0 0 10px #3b82f6;
    }
    /* Label style (for CSS2DRenderer) */
    #asteroid-map-section .label {
        color: #56d9f9;
        font-size: 0.75rem;
        font-weight: 600;
        pointer-events: none; /* Allow clicks to pass through to asteroids */
        user-select: none;
        white-space: nowrap;
        text-shadow:
            -1px -1px 0 #000,
            1px -1px 0 #000,
            -1px 1px 0 #000,
            1px 1px 0 #000;
        transform: translate(-50%, 100%); /* Position label below asteroid */
        z-index: 1; /* Ensure labels are behind UI elements */
    }

    /* Modal styles */
    #asteroid-map-section #asteroid-map-guide-modal-overlay { /* Changed ID to avoid conflict */
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8);
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    #asteroid-map-section #asteroid-map-guide-modal { /* Changed ID to avoid conflict */
        background: rgba(8, 19, 42, 0.95);
        padding: 20px 30px;
        border-radius: 1rem;
        max-width: 400px;
        color: #cbd5e1;
        box-shadow: 0 0 15px rgba(86, 217, 249, 0.7);
        font-size: 14px;
        line-height: 1.5;
        position: relative;
        border: 1px solid #1e293b;
    }
    #asteroid-map-section #asteroid-map-guide-modal h2 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #56d9f9;
        border-bottom: 1px solid #1e293b;
        padding-bottom: 5px;
        text-shadow: 0 0 6px #56d9f9;
    }
    #asteroid-map-section #asteroid-map-guide-modal button.close-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: #a0e7e5;
        font-size: 1.4rem;
        cursor: pointer;
        padding: 0;
        width: 28px;
        height: 28px;
        line-height: 28px;
        text-align: center;
    }
    #asteroid-map-section #asteroid-map-guide-modal button.close-modal:hover {
        color: #56d9f9;
    }
    
    /* Animation controls */
    #asteroid-map-section #asteroid-map-animation-controls { /* Changed ID to avoid conflict */
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 1rem;
        align-items: center;
        background: rgba(8, 19, 42, 0.8);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid #1e293b;
        z-index: 25;
    }
    #asteroid-map-section #asteroid-map-animation-controls label {
        margin-right: 0.5rem;
    }
    #asteroid-map-section #asteroid-map-animation-controls select {
        background: rgba(11, 23, 50, 0.45);
        border: 1px solid #2c3b62;
        border-radius: 0.5rem;
        color: #cbd5e1;
        padding: 0.4rem 0.6rem;
        font-size: 0.9rem;
    }
    #asteroid-map-section #asteroid-map-animation-toggle {
        background-color: #0a143e;
        border: none;
        border-radius: 0.5rem;
        color: white;
        padding: 0.5rem 1.75rem;
        font-size: 0.9rem;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    #asteroid-map-section #asteroid-map-animation-toggle.active {
        background-color: #1e40af;
        box-shadow: 0 0 10px #3b82f6;
    }
    
    /* Speed slider container */
    #asteroid-map-section #asteroid-map-speed-slider-container { /* Changed ID to avoid conflict */
        position: absolute;
        bottom: 5rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        gap: 0.5rem;
        align-items: center;
        background: rgba(8, 19, 42, 0.8);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid #1e293b;
        z-index: 25;
        width: 350px; /* Increased width to accommodate the switch */
        max-width: 90vw; /* Ensure responsiveness */
        justify-content: center; /* Center items horizontally */
    }
    #asteroid-map-section #asteroid-map-speed-slider {
        flex: 1;
        -webkit-appearance: none;
        height: 5px;
        background: #2c3b62;
        border-radius: 5px;
        outline: none;
        min-width: 100px; /* Ensure slider doesn't get too small */
    }
    #asteroid-map-section #asteroid-map-speed-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #56d9f9;
        cursor: pointer;
    }
    #asteroid-map-section #asteroid-map-speed-value {
        min-width: 40px;
        text-align: center;
        font-size: 0.8rem;
    }

    /* Label visibility switch */
    #asteroid-map-section .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 20px;
        margin-left: 0.5rem; /* Space between label and switch */
    }
    #asteroid-map-section .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    #asteroid-map-section .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #2c3b62;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 20px;
    }
    #asteroid-map-section .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 50%;
    }
    #asteroid-map-section input:checked + .slider {
        background-color: #56d9f9;
    }
    #asteroid-map-section input:focus + .slider {
        box-shadow: 0 0 1px #56d9f9;
    }
    #asteroid-map-section input:checked + .slider:before {
        -webkit-transform: translateX(14px);
        -ms-transform: translateX(14px);
        transform: translateX(14px);
    }
    #asteroid-map-section .control-group.label-switch {
        display: flex;
        align-items: center;
        /* Removed gap here as it's handled by the switch margin-left */
    }

    @media (max-width: 768px) {
        #asteroid-map-section .asteroid-map-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        #asteroid-map-section .controls {
            width: 100%;
            justify-content: space-between;
        }
        #asteroid-map-section #asteroid-map-info-panel {
            width: 90vw;
            right: 5vw;
            top: 5vh;
        }
        #asteroid-map-section #asteroid-map-ui-buttons {
            flex-direction: row;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            top: auto;
        }
        #asteroid-map-section #asteroid-map-animation-controls {
            flex-direction: column;
            gap: 0.5rem;
            width: 90%;
            bottom: 5rem;
        }
        #asteroid-map-section #asteroid-map-speed-slider-container {
            width: 90%;
            bottom: 9rem;
            flex-direction: column; /* Stack items vertically on small screens */
            align-items: center;
        }
        #asteroid-map-section #asteroid-map-speed-slider-container .control-group.label-switch {
            margin-top: 0.5rem; /* Add some space when stacked */
        }
    }

    /* Styles from impact.html */
    #mitigation-map-section {
        display: none; /* Hidden by default */
        width: 100%;
        min-height: calc(100vh - 80px); /* Adjust based on header/footer height */
    }
    #mitigation-map-section .mitigation-container { /* Changed to avoid conflict */
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto 1fr auto;
        grid-template-areas:
            "header header"
            "earth asteroids"
            "scenarios scenarios";
        gap: 20px;
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
        min-height: 100vh;
    }

    @media (max-width: 768px) {
        #mitigation-map-section .mitigation-container {
            grid-template-columns: 1fr;
            grid-template-areas:
                "header"
                "earth"
                "asteroids"
                "scenarios";
        }
    }

    #mitigation-map-section .mitigation-header { /* Changed to avoid conflict */
        grid-area: header;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #1e293b;
    }

    #mitigation-map-section .header-text {
        font-size: 1.8rem;
        font-weight: 300;
        letter-spacing: 1px;
        color: #56d9f9;
        text-shadow: 0 0 6px #56d9f9;
    }

    #mitigation-map-section .earth-container {
        grid-area: earth;
        position: relative;
        width: 100%;
        height: 500px;
        background: rgba(8, 19, 42, 0.65);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        border: 1px solid #1e293b;
    }

    #mitigation-map-section #mitigation-map-earth-canvas { /* Changed ID to avoid conflict */
        width: 100%;
        height: 100%;
    }

    #mitigation-map-section .help-btn-container {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
    }

    #mitigation-map-section .help-btn {
        background: #0a143e;
        color: #56d9f9;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: background 0.3s, box-shadow 0.3s;
        box-shadow: 0 0 10px rgba(86, 217, 249, 0.5);
    }

    #mitigation-map-section .help-btn:hover {
        background: #1e40af;
        box-shadow: 0 0 15px rgba(86, 217, 249, 0.7);
    }

    #mitigation-map-section .asteroids-container {
        grid-area: asteroids;
        background: rgba(8, 19, 42, 0.65);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        max-height: 500px;
        border: 1px solid #1e293b;
    }

    #mitigation-map-section .asteroids-title {
        font-size: 1.5rem;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #1e293b;
        color: #56d9f9;
        text-shadow: 0 0 6px #56d9f9;
    }

    #mitigation-map-section .asteroid-list {
        list-style: none;
    }

    #mitigation-map-section .asteroid-item {
        padding: 12px 15px;
        margin-bottom: 10px;
        background: rgba(11, 23, 50, 0.45);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
        border: 1px solid #2c3b62;
    }

    #mitigation-map-section .asteroid-item:hover {
        background: rgba(30, 41, 59, 0.6);
        transform: translateX(5px);
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
    }

    #mitigation-map-section .asteroid-item.active {
        background: rgba(58, 31, 31, 0.6);
        border-left: 4px solid #ff4444;
        box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
    }

    #mitigation-map-section .asteroid-name {
        font-weight: 500;
        margin-bottom: 5px;
        color: #e0e0e0;
    }

    #mitigation-map-section .asteroid-details {
        font-size: 0.85rem;
        color: #a0e7e5;
    }

    #mitigation-map-section .scenarios-container {
        grid-area: scenarios;
        background: rgba(8, 19, 42, 0.65);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        min-height: 200px;
        border: 1px solid #1e293b;
    }

    #mitigation-map-section .scenarios-title {
        font-size: 1.5rem;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #1e293b;
        color: #56d9f9;
        text-shadow: 0 0 6px #56d9f9;
    }

    #mitigation-map-section .scenarios-content {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    #mitigation-map-section .hazard-item {
        display: flex;
        align-items: center;
        background: rgba(11, 23, 50, 0.45);
        padding: 10px 15px;
        border-radius: 8px;
        min-width: 200px;
        border: 1px solid #2c3b62;
        transition: box-shadow 0.3s;
    }

    #mitigation-map-section .hazard-item:hover {
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }

    #mitigation-map-section .hazard-emoji {
        font-size: 1.5rem;
        margin-right: 10px;
    }

    #mitigation-map-section .hazard-text {
        font-size: 0.9rem;
        color: #cbd5e1;
    }

    #mitigation-map-section .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 100;
        justify-content: center;
        align-items: center;
    }

    #mitigation-map-section .modal-content {
        background: rgba(8, 19, 42, 0.95);
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        border: 1px solid #1e293b;
    }

    #mitigation-map-section .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    #mitigation-map-section .modal-title {
        font-size: 1.5rem;
        color: #56d9f9;
        text-shadow: 0 0 6px #56d9f9;
    }

    #mitigation-map-section .close-btn {
        background: none;
        border: none;
        color: #e0e0e0;
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.3s;
    }

    #mitigation-map-section .close-btn:hover {
        color: #56d9f9;
    }

    #mitigation-map-section .hazard-list {
        list-style: none;
    }

    #mitigation-map-section .hazard-list li {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #1e293b;
    }

    #mitigation-map-section .hazard-list li:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    #mitigation-map-section .loading {
        text-align: center;
        padding: 20px;
        color: #a0e7e5;
    }

    #mitigation-map-section .error {
        text-align: center;
        padding: 20px;
        color: #ff6b6b;
    }

    #mitigation-map-section .impact-coordinates {
        margin-top: 10px;
        font-size: 0.85rem;
        color: #a0e7e5;
    }

    #mitigation-map-section .impact-coordinates span {
        color: #fbbf24;
        font-weight: 600;
    }

    #mitigation-map-section .scenario-description {
        width: 100%;
        padding: 15px;
        background: rgba(11, 23, 50, 0.45);
        border-radius: 8px;
        border: 1px solid #2c3b62;
        margin-bottom: 15px;
        color: #cbd5e1;
        line-height: 1.5;
    }
    
    #mitigation-map-section .retry-btn {
        background: #1e40af;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        transition: background 0.3s;
    }
    
    #mitigation-map-section .retry-btn:hover {
        background: #3b82f6;
    }

    /* Styles for the Impactor 2025 section */
    #impactor-2025-section {
        display: none; /* Hidden by default */
        width: 100%;
        min-height: calc(100vh - 80px); /* Adjust based on header/footer height */
        /* Styles copied from impactor.html body and container */
        font-family: 'Orbitron', sans-serif;
        background: radial-gradient(ellipse at bottom, #050e26 0%, #000014 100%);
        color: #cbd5e1;
        overflow: hidden;
        height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    #impactor-2025-section .container {
        display: flex;
        height: 100vh;
        padding: 20px;
        gap: 20px;
    }
    #impactor-2025-section .model-container {
        flex: 1;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 15px;
        box-shadow: 0 0 30px rgba(0, 100, 255, 0.2);
        overflow: hidden;
        position: relative;
    }
    #impactor-2025-section #solarSystemCanvas {
        width: 100%;
        height: 100%;
        display: block;
    }
    #impactor-2025-section .data-panel {
        width: 400px;
        background: rgba(8, 19, 42, 0.95);
        border: 1px solid #1e293b;
        border-radius: 1rem;
        padding: 25px;
        box-shadow: 0 0 25px rgba(86, 217, 249, 0.5);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    #impactor-2025-section h1 {
        color: #56d9f9;
        text-align: center;
        margin-bottom: 10px;
        font-size: 1.8rem;
        font-weight: 700;
        text-shadow: 0 0 10px rgba(86, 217, 249, 0.5);
    }
    #impactor-2025-section .subtitle {
        text-align: center;
        color: #a0e7e5;
        margin-bottom: 25px;
        font-size: 1rem;
    }
    #impactor-2025-section .data-section {
        background-color: rgba(11, 23, 50, 0.45);
        border-radius: 0.75rem;
        padding: 15px;
        border: 1px solid #2c3b62;
        box-shadow: 0 0 10px rgb(58 73 121 / 0.6);
    }
    #impactor-2025-section h2 {
        color: #56d9f9;
        margin-bottom: 15px;
        font-size: 1.3rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #impactor-2025-section .data-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(44, 59, 98, 0.2);
    }
    #impactor-2025-section .data-label {
        color: #a0e7e5;
        font-weight: 500;
    }
    #impactor-2025-section .data-value {
        color: #cbd5e1;
        font-weight: 600;
    }
    #impactor-2025-section .warning {
        color: #ffbb33;
        font-weight: bold;
    }
    #impactor-2025-section .caution {
        color: #fbbf24;
        font-weight: bold;
    }
    #impactor-2025-section .safe {
        color: #69f0ae;
        font-weight: bold;
    }
    #impactor-2025-section .impact-visualization {
        height: 120px;
        background-color: rgba(8, 19, 42, 0.65);
        border-radius: 1rem;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #cbd5e1;
        font-style: italic;
        text-align: center;
        padding: 10px;
        border: 1px solid #1e293b;
        box-shadow: 0 0 15px rgb(8 25 56 / 0.75);
    }
    #impactor-2025-section .controls {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    #impactor-2025-section .main-controls {
        display: flex;
        gap: 10px;
    }
    #impactor-2025-section .back-button-container {
        margin-top: 10px;
    }
    #impactor-2025-section button {
        flex: 1;
        padding: 0.5rem 1rem; /* Decreased padding */
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 0 10px #3b82f6;
        font-size: 0.7rem; /* Decreased font size */
    }
    #impactor-2025-section button:hover {
        background-color: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 0 15px #2563eb;
    }
    #impactor-2025-section button.active {
        background: linear-gradient(135deg, #ff5252, #b71c1c);
        box-shadow: 0 0 15px rgba(255, 82, 82, 0.5);
    }
    #impactor-2025-section .back-button {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        box-shadow: 0 0 10px rgba(107, 114, 128, 0.5);
        cursor: pointer; /* Changed to pointer */
        opacity: 1; /* Changed to 1 */
    }
    #impactor-2025-section .back-button:hover {
        background: linear-gradient(135deg, #4b5563, #6b7280); /* Adjusted hover for consistency */
        transform: translateY(-2px); /* Added transform for consistency */
        box-shadow: 0 0 15px rgba(107, 114, 128, 0.8); /* Adjusted shadow for consistency */
    }
    #impactor-2025-section .loading {
        text-align: center;
        color: #a0e7e5;
        font-style: italic;
    }
    #impactor-2025-section .notification {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(8, 19, 42, 0.95);
        color: #56d9f9;
        padding: 10px 20px;
        border-radius: 1rem;
        box-shadow: 0 0 25px rgba(86, 217, 249, 0.5);
        z-index: 100;
        font-weight: 700;
        animation: pulse 2s infinite;
        border: 1px solid #1e293b;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(86, 217, 249, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(86, 217, 249, 0); }
        100% { box-shadow: 0 0 0 0 rgba(86, 217, 249, 0); }
    }
    @media (max-width: 1100px) {
        #impactor-2025-section .container {
            flex-direction: column;
            height: auto;
        }
        #impactor-2025-section .model-container {
            height: 60vh;
        }
        #impactor-2025-section .data-panel {
            width: 100%;
            height: 40vh;
        }
        #impactor-2025-section .controls {
            flex-direction: column;
        }
        #impactor-2025-section .main-controls {
            flex-direction: column;
        }
    }

    /* Styles for dropdowns in third-page */
    .dropdown-container {
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        text-align: left;
    }

    .dropdown-container label {
        font-size: 1.1rem;
        color: #a0e7e5;
        margin-bottom: 0.5rem;
        display: block;
    }

    .dropdown-container select {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #2c3b62;
        background-color: #050e26;
        color: #cbd5e1;
        font-size: 1rem;
        appearance: none; /* Remove default arrow */
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23cbd5e1%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 0.65em auto;
    }

    .dropdown-container select:focus {
        outline: none;
        border-color: #56d9f9;
        box-shadow: 0 0 8px rgba(86, 217, 249, 0.5);
    }

    /* Style for the strategy detail boxes */
    .strategy-detail-box {
      margin-top: 1rem;
      padding: 1.5rem;
      background-color: rgba(11, 23, 50, 0.45); /* Same as card background */
      border-radius: 0.75rem;
      border: 1px solid #2c3b62; /* Same as card border */
      box-shadow: 0 0 10px rgb(58 73 121 / 0.6); /* Same as card shadow */
      color: #cbd5e1;
      text-align: left;
      display: none; /* Hidden by default */
    }
    .strategy-detail-box h3 {
      font-size: 1.5rem;
      color: #56d9f9;
      margin-bottom: 0.75rem;
    }
    .strategy-detail-box p {
      font-size: 1rem;
      line-height: 1.5;
      margin-bottom: 0.5rem;
    }
    .strategy-detail-box p strong {
      color: #fbbf24;
    }

    /* New styles for dropdown containers to match strategy-detail-box */
    .dropdown-wrapper {
      margin-top: 1rem;
      padding: 1.5rem;
      background-color: rgba(11, 23, 50, 0.45);
      border-radius: 0.75rem;
      border: 1px solid #2c3b62;
      box-shadow: 0 0 10px rgb(58 73 121 / 0.6);
      color: #cbd5e1;
      text-align: left;
    }

    /* Video container styles */
    .video-container {
      margin-bottom: 1rem;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 0 10px rgb(58 73 121 / 0.6);
      background-color: #000;
    }
    .video-container video {
      width: 100%;
      height: auto;
      display: block;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen logged-out">

  <!-- Top Navigation -->
  <header class="w-full px-6 py-4 flex justify-between items-center border-b border-indigo-800 rounded-b-md rounded-t-none">
    <h1 id="main-title" class="text-white text-3xl font-extrabold tracking-widest select-none drop-shadow-[0_0_10px_rgba(86,217,249,0.9)]">THE FINAL SMASHERS</h1>
    
    <!-- New Buttons Container -->
    <div class="flex items-center gap-4 ml-auto mr-4"> <!-- Added ml-auto to push to right, mr-4 for spacing -->
        <button class="header-btn" id="simulation-tool-btn">Simulation Tool</button>
        <button class="header-btn" id="asteroid-map-btn">Asteroid Map</button>
        <button class="header-btn" id="mitigation-map-btn">impact Map</button>
    </div>

    <div id="auth-controls" class="flex items-center gap-4">
        <div id="user-info" style="display: none;">
            <span>Welcome, <span id="display-username"></span> (<span id="display-role"></span>)</span>
            <button id="logout-btn">Logout</button>
        </div>
        <button id="login-signup-btn">Login / Sign Up</button>
    </div>
  </header>

  <div id="main-content-wrapper">
    <main>
      <!-- Hero Section (Main Page) -->
      <section id="hero-section" class="rounded-container mx-6 my-6 p-8 flex flex-col md:flex-row items-center gap-8 md:gap-16 shadow-lg select-none">
        <!-- Left Text Content -->
        <div class="flex-1 max-w-3xl text-center md:text-left">
          <h2 class="text-white drop-shadow-[0_0_10px_rgba(86,217,249,0.9)] text-4xl md:text-5xl font-extrabold leading-tight tracking-wide uppercase">
            Explore<br />
            <span class="text-cyan-400">Asteroids</span> and<br />
            Potential Impacts
          </h2>
          <button id="learn-more-btn" aria-label="Wanna go further?" 
            class="learn-more-btn mt-8 text-white shadow-md shadow-cyan-700 hover:shadow-cyan-400 focus-visible:ring-4 focus-visible:ring-cyan-400 focus-visible:ring-opacity-70">
            Wanna Go Further?
          </button>
        </div>

        <!-- Right Space Illustration (Main Page Card) -->
        <div class="flex-1 max-w-lg w-full relative rounded-lg overflow-hidden shadow-xl" aria-hidden="true">
          <img 
            src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/4d1b89f0-b78f-406e-876c-ac7dade91311.png"
            alt="Digital art showing asteroid floating near earth, a fiery comet in space with glowing stars and deep blue space background, with an orange impact glow on Earth's surface"
            onerror="this.style.display='none';"
          />
        </div>
      </section>

      <!-- NEW ASTEROID UNDER STUDY SECTION (Main Page Card) -->
      <section class="new-asteroid-container select-none" aria-label="New Asteroid Under Study Information">
        <div class="new-asteroid-content">
          <h1><span>NEW ASTEROID</span><br>UNDER STUDY</h1>
          <div class="asteroid-id">2025VX1 (IMPACTOR 2025)</div>
          <div class="details">
            <p><span>Location:</span> under study</p>
            <p><span>Estimated Size:</span> 500 meters in diameter</p>
            <p><span>Potential Impact:</span> may produce cataclysmic effects like tremendous shockwaves, tsunamis, and worldwide climatic disruption from the sun's blockage due to dust and debris.</p>
          </div>
          <button id="hypothetical-simulation-btn" class="learn-more-btn mt-4 text-white shadow-md shadow-yellow-700 hover:shadow-yellow-400 focus-visible:ring-4 focus-visible:ring-yellow-400 focus-visible:ring-opacity-70">
            Hypothetical Simulation
          </button>
        </div>

        <div class="image-container">
          <img src="https://res.cloudinary.com/dnm8wfn38/image/upload/v1759524096/understudy_jlalkx.png" alt="Asteroid" />
        </div>
      </section>

      <!-- Info Cards Section (empty) - hidden on main page -->
      <section id="info-cards" class="mx-6 mb-6 grid grid-cols-1 sm:grid-cols-1 gap-6 select-none" style="display:none;">
      </section>

      <!-- Second Page Section - Initially Hidden -->
      <section id="second-page" class="mx-6 mb-10 select-none" aria-label="Further Asteroids">
        <header class="text-center mb-10">
          <h1 id="second-page-title" class="text-white text-4xl font-extrabold tracking-widest drop-shadow-[0_0_12px_rgba(86,217,249,0.85)] uppercase">FURTHER ASTEROIDS</h1>
          <p class="text-cyan-400 text-lg tracking-wide mt-1 font-semibold">THE COSMIC IMPACT EXPLORER</p>
        </header>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 max-w-7xl mx-auto" id="second-page-cards">
          <!-- Asteroid cards will be dynamically loaded here -->
        </div>
        <div class="text-center mt-10">
          <button id="back-to-main-btn" aria-label="Back to main page"
            class="learn-more-btn text-white shadow-md shadow-cyan-700 hover:shadow-cyan-400 focus-visible:ring-4 focus-visible:ring-cyan-400 focus-visible:ring-opacity-70">
            Back to the Main Page
          </button>
        </div>
      </section>

      <!-- Third Page Section - Invisible on main page -->
      <section id="third-page" aria-label="Asteroid details" class="select-none" role="region">
        <img id="third-page-image" src="https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg" alt="Earth seen from space with background of stars and nebula" />
        <div id="third-page-content">
          <h1 id="third-page-title">
            The Invisible<br />
            <span>Forces</span>
          </h1>
          <p id="third-page-description">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
          </p>

          <!-- Deflection Strategies Dropdown -->
          <div class="dropdown-wrapper" id="deflection-strategies-dropdown">
            <label for="deflection-strategy-select">Deflection Strategies:</label>
            <select id="deflection-strategy-select">
              <option value="">Select a strategy</option>
              <option value="kinetic_impactor">Kinetic Impactor</option>
              <option value="gravity_tractor">Gravity Tractor</option>
              <option value="nuclear_detonation">Nuclear Detonation</option>
              <option value="laser_ablation">Laser Ablation</option>
            </select>
            <div id="deflection-strategy-video-container" class="video-container" style="display:none;">
                <video controls muted loop autoplay></video>
            </div>
            <div id="deflection-strategy-details" class="strategy-detail-box"></div>
          </div>

          <!-- Mitigation Strategies Dropdown -->
          <div class="dropdown-wrapper" id="mitigation-strategies-dropdown">
            <label for="mitigation-strategy-select">Mitigation Strategies:</label>
            <select id="mitigation-strategy-select">
              <option value="">Select a strategy</option>
              <option value="evacuation">Evacuation</option>
              <option value="shelter_in_place">Shelter-in-Place</option>
              <option value="infrastructure_hardening">Infrastructure Hardening</option>
              <option value="early_warning_systems">Early Warning Systems</option>
            </select>
            <div id="mitigation-strategy-details" class="strategy-detail-box"></div>
          </div>

          <button class="back-btn" type="button" aria-label="Back to asteroids page">Back to Asteroids</button>
        </div>
      </section>

      <!-- Scientist Exclusive Content -->
      <section id="scientist-exclusive-content" class="select-none">
          <h2>Scientist Access Only</h2>
          <p>Welcome, esteemed scientist! Here you can find advanced research data and tools related to cosmic impacts. This section is only visible to users logged in as 'Scientist'.</p>
          <p>Imagine this area filled with interactive charts, real-time tracking, and simulation access.</p>
      </section>

      <!-- Simulation Tool Section -->
      <section id="simulation-tool" class="select-none">
        <h2>Asteroid Impact Simulation Tool</h2>
        <div class="input-group">
          <label for="asteroid-size">Asteroid Diameter (meters):</label>
          <input type="number" id="asteroid-size" value="50" min="1" max="10000">
        </div>
        <div class="input-group">
          <label for="asteroid-velocity">Impact Velocity (km/s):</label>
          <input type="number" id="asteroid-velocity" value="20" min="1" max="50">
        </div>
        <div class="input-group">
          <label for="target-type">Target Surface:</label>
          <select id="target-type">
            <option value="land">Land</option>
            <option value="ocean">Ocean</option>
          </select>
        </div>
        <button id="run-simulation-btn">Run Simulation</button>
        <div id="simulation-results" style="display:none;">
          <h3>Simulation Results</h3>
          <p>Impact Energy: <span id="result-energy"></span></p>
          <p>Crater Diameter: <span id="result-crater"></span></p>
          <p>Ejecta Blanket: <span id="result-ejecta"></span></p>
          <p>Potential Effects: <span id="result-effects"></span></p>
        </div>
        <div class="text-center mt-10">
          <button id="simulation-return-home-btn" aria-label="Return to Home Page"
            class="learn-more-btn text-white shadow-md shadow-cyan-700 hover:shadow-cyan-400 focus-visible:ring-4 focus-visible:ring-cyan-400 focus-visible:ring-opacity-70">
            Return to Home Page
          </button>
        </div>
      </section>

      <!-- Impactor 2025 Section (from impactor.html) -->
      <section id="impactor-2025-section">
        <div class="notification" id="notification">Solar System View - Tracking Impactor 2025</div>
        
        <div class="container">
            <div class="model-container">
                <canvas id="solarSystemCanvas"></canvas>
            </div>
            
            <div class="data-panel">
                <div>
                    <h1>IMPACTOR 2025</h1>
                    <p class="subtitle">Solar System Tracking & Impact Analysis</p>
                </div>
                
                <div class="data-section">
                    <h2>Orbital Parameters</h2>
                    <div class="data-row">
                        <span class="data-label">Semi-major Axis:</span>
                        <span class="data-value" id="semiMajorAxis">1.82 AU</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Eccentricity:</span>
                        <span class="data-value" id="eccentricity">0.42</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Inclination:</span>
                        <span class="data-value" id="inclination">12.7</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Orbital Period:</span>
                        <span class="data-value" id="orbitalPeriod">2.46 years</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Next Close Approach:</span>
                        <span class="data-value" id="closeApproach">2025-09-14</span>
                    </div>
                </div>
                
                <div class="data-section">
                    <h2>Physical Characteristics</h2>
                    <div class="data-row">
                        <span class="data-label">Estimated Diameter:</span>
                        <span class="data-value" id="diameter">320 m</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Mass:</span>
                        <span class="data-value" id="mass">2.110 kg</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Rotation Period:</span>
                        <span class="data-value" id="rotationPeriod">6.3 hours</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Spectral Class:</span>
                        <span class="data-value" id="spectralClass">S-type</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Albedo:</span>
                        <span class="data-value" id="albedo">0.23</span>
                    </div>
                </div>
                
                <div class="data-section">
                    <h2>Impact Risk Assessment</h2>
                    <div class="data-row">
                        <span class="data-label">Torino Scale:</span>
                        <span class="data-value caution" id="torinoScale">Level 2</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Impact Probability:</span>
                        <span class="data-value caution" id="impactProbability">1 in 12,500</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Palermo Scale:</span>
                        <span class="data-value safe" id="palermoScale">-1.72</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Current Distance:</span>
                        <span class="data-value" id="currentDistance">0.082 AU</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Relative Velocity:</span>
                        <span class="data-value" id="relativeVelocity">15.2 km/s</span>
                    </div>
                </div>
                
                <div class="data-section">
                    <h2>Potential Impact Effects</h2>
                    <div class="data-row">
                        <span class="data-label">Impact Energy:</span>
                        <span class="data-value warning" id="impactEnergy">120 MT</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Equivalent Quake:</span>
                        <span class="data-value" id="equivalentQuake">7.8 Mw</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Crater Diameter:</span>
                        <span class="data-value" id="craterDiameter">3.2 km</span>
                    </div>
                    <div class="impact-visualization" id="impactVisualization">
                        Solar System View - Earth shown to scale with asteroid
                    </div>
                </div>
                
                <div class="controls">
                    <div class="main-controls">
                        <button id="simulateOrbit">Simulate Orbit</button>
                        <button id="impactScenario">Impact Scenario</button>
                        <button id="resetView">Reset View</button>
                    </div>
                    <div class="back-button-container">
                        <button id="backToMain" class="learn-more-btn">Back to Main Page</button>
                    </div>
                </div>
                
                <div class="loading">
                    <p>Connected to NASA NEO API - Data updating</p>
                </div>
            </div>
        </div>
      </section>

      <!-- Asteroid Map Section (from kkkk.html) -->
      <section id="asteroid-map-section">
        <header class="asteroid-map-header">
          <h1>3D Asteroid Explorer</h1>
          <div class="controls">
            <div class="control-group">
              <label for="asteroid-map-date-select">Date:</label>
              <input type="date" id="asteroid-map-date-select" />
            </div>
            <div class="control-group">
              <label for="asteroid-map-timespan">Timespan:</label>
              <select id="asteroid-map-timespan">
                <option value="7" selected>7 days</option>
                <option value="14">14 days</option>
                <option value="30">30 days</option>
              </select>
            </div>
            <button id="asteroid-map-fetch-data" class="map-button">Update Data</button>
          </div>
        </header>

        <div id="map-container">
          <div id="asteroid-map-scene-container"></div>

          <div id="asteroid-map-info-panel" aria-live="polite" role="region">
            <button id="asteroid-map-close-info" aria-label="Close info panel">&times;</button>
            <h2>Asteroid Details</h2>
            <div class="info-item"><span class="info-label">Name:</span> <span class="info-value" id="asteroid-map-info-name">-</span></div>
            <div class="info-item"><span class="info-label">Designation:</span> <span class="info-value" id="asteroid-map-info-designation">-</span></div>
            <div class="info-item"><span class="info-label">Diameter:</span> <span class="info-value" id="asteroid-map-info-diameter">-</span></div>
            <div class="info-item"><span class="info-label">Close Approach:</span> <span class="info-value" id="asteroid-map-info-approach">-</span></div>
            <div class="info-item"><span class="info-label">Velocity:</span> <span class="info-value" id="asteroid-map-info-velocity">-</span></div>
            <div class="info-item"><span class="info-label">Orbiting Body:</span> <span class="info-value" id="asteroid-map-info-body">-</span></div>
            <div class="info-item"><span class="info-label">NASA Link:</span> <span class="info-value"><a id="asteroid-map-info-link" href="#" target="_blank" rel="noopener noreferrer">View Details</a></span></div>
          </div>

          <div id="asteroid-map-loading" role="alert" aria-busy="true">
            <div class="spinner"></div>
            <p>Loading asteroid data...</p>
          </div>

          <div id="asteroid-map-error-message" role="alert">
            <h3>Error Loading Data</h3>
            <p>Failed to fetch asteroid data from NASA API.</p>
            <p>Using demo data instead.</p>
            <button id="asteroid-map-dismiss-error" class="map-button">Dismiss</button>
          </div>

          <div id="asteroid-map-ui-buttons" aria-label="Map controls">
            <button id="asteroid-map-zoom-in" title="Zoom In" aria-label="Zoom In" class="map-button">+</button>
            <button id="asteroid-map-zoom-out" title="Zoom Out" aria-label="Zoom Out" class="map-button"></button>
            <button id="asteroid-map-guide-button" title="Guide" aria-label="Guide" class="map-button">?</button>
          </div>

          <div id="asteroid-map-speed-slider-container">
            <label for="asteroid-map-speed-slider">Speed:</label>
            <input type="range" id="asteroid-map-speed-slider" min="0" max="2" step="0.01" value="0.5">
            <span id="asteroid-map-speed-value">Normal</span>
            <div class="control-group label-switch">
              <label for="asteroid-map-toggle-labels">Show Labels:</label>
              <label class="switch">
                <input type="checkbox" id="asteroid-map-toggle-labels" checked>
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div id="asteroid-map-animation-controls">
            <button id="asteroid-map-animation-toggle" class="map-button">Pause Orbits</button>
          </div>
        </div>

        <!-- Guide Modal -->
        <div id="asteroid-map-guide-modal-overlay">
          <div id="asteroid-map-guide-modal">
            <button class="close-modal" aria-label="Close guide">&times;</button>
            <h2>How to Use the Explorer</h2>
            <p><strong>Zoom In/Out:</strong> Use the '+' and '-' buttons on the top-left, or scroll with your mouse wheel/trackpad.</p>
            <p><strong>Rotate Map:</strong> Click and drag the left mouse button (or one finger on trackpad) to rotate the view around the Sun.</p>
            <p><strong>Move Camera (Pan):</strong> Click and drag the right mouse button (or two fingers on trackpad) to move the camera sideways.</p>
            <p><strong>Select Asteroid:</strong> Click on an asteroid to view its details in the info panel.</p>
            <p><strong>Update Data:</strong> Select a date and timespan, then click 'Update Data' to fetch new asteroid information from NASA.</p>
            <p><strong>Animation Controls:</strong> Use the speed slider at the bottom to control asteroid motion speed, and the pause button to stop/resume orbits.</p>
            <p><strong>Show Labels:</strong> Use the toggle switch next to the speed slider to show or hide asteroid, Sun, and Earth labels.</p>
          </div>
        </div>
        <div class="text-center mt-10">
          <button id="asteroid-map-return-home-btn" aria-label="Return to Home Page"
            class="learn-more-btn text-white shadow-md shadow-cyan-700 hover:shadow-cyan-400 focus-visible:ring-4 focus-visible:ring-cyan-400 focus-visible:ring-opacity-70">
            Return to Home Page
          </button>
        </div>
      </section>

      <!-- Mitigation Map Section (from impact.html) -->
      <section id="mitigation-map-section">
        <div class="mitigation-container">
            <header class="mitigation-header">
                <div class="header-text">impact scenarios and danger zone</div>
            </header>

            <div class="earth-container">
                <div class="help-btn-container">
                    <button class="help-btn" id="mitigation-map-help-btn">?</button>
                </div>
                <div id="mitigation-map-earth-canvas"></div>
            </div>

            <div class="asteroids-container">
                <h2 class="asteroids-title">Asteroid name</h2>
                <ul class="asteroid-list" id="mitigation-map-asteroid-list">
                    <li class="loading">Loading asteroid data...</li>
                </ul>
            </div>

            <div class="scenarios-container">
                <h2 class="scenarios-title">Impact scenarios:</h2>
                <div class="scenarios-content" id="mitigation-map-scenarios-content">
                    <div class="loading">Select an asteroid to view impact scenarios</div>
                </div>
            </div>
        </div>

        <div class="modal" id="mitigation-map-help-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Hazard Guide</h3>
                    <button class="close-btn" id="mitigation-map-close-modal">&times;</button>
                </div>
                <ul class="hazard-list">
                    <li><span class="hazard-emoji"></span> <span class="hazard-text">Blast waves and overpressure</span></li>
                    <li><span class="hazard-emoji"></span> <span class="hazard-text">Thermal radiation</span></li>
                    <li><span class="hazard-emoji"></span> <span class="hazard-text">Cratering</span></li>
                    <li><span class="hazard-emoji"></span> <span class="hazard-text">Seismic shaking</span></li>
                    <li><span class="hazard-emoji"></span> <span class="hazard-text">Tsunami</span></li>
                    <li><span class="hazard-emoji"></span> <span class="hazard-text">Debris ejecta & atmospheric effects (blocking sunlight)</span></li>
                    <li><span class="hazard-emoji"></span> <span class="hazard-text">Cascading hazards</span></li>
                </ul>
            </div>
        </div>
        <div class="text-center mt-10">
          <button id="mitigation-map-return-home-btn" aria-label="Return to Home Page"
            class="learn-more-btn text-white shadow-md shadow-cyan-700 hover:shadow-cyan-400 focus-visible:ring-4 focus-visible:ring-cyan-400 focus-visible:ring-opacity-70">
            Return to Home Page
          </button>
        </div>
      </section>

    </main>
  </div> <!-- End main-content-wrapper -->

  <footer class="w-full text-center py-4 text-gray-500 text-sm select-none border-t border-indigo-800">
    &copy; 2025 The Final Smashers. All rights reserved.
  </footer>

  <!-- Chatbot Button -->
  <button id="chatbot-btn" aria-label="Open chatbot"></button>

  <!-- Chatbot Modal -->
  <div id="chatbot-modal">
      <div id="chatbot-header">
          <h3>Asteroid AI Chatbot</h3>
          <p>Ask me about asteroids!</p>
      </div>
      <div id="chat-messages"></div>
      <div id="chat-input-container">
          <input type="text" id="chat-input" placeholder="Type your asteroid question..." aria-label="Chat input">
          <button id="chat-send-btn" aria-label="Send message">Send</button>
      </div>
  </div>

  <!-- Sign-up/Login Gate Modal -->
  <div id="gate-modal">
      <div id="gate-content">
          <h2 id="gate-title">Login</h2>
          <form id="login-form">
              <!-- Earth Planet Eye -->
              <div id="earth-container">
                  <img id="earth-planet" src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/The_Earth_seen_from_Apollo_17.jpg/1024px-The_Earth_seen_from_Apollo_17.jpg" alt="Earth Planet" />
                  <div id="earth-eyelid"></div>
              </div>

              <input type="text" id="login-username" placeholder="Username" required />
              <input type="password" id="login-password" placeholder="Password" required />
              <div id="login-message" class="text-red-500 text-sm mt-2 min-h-[1.5rem]"></div>
              <button type="submit" class="primary-btn">Login</button>
              <button type="button" id="show-signup-btn" class="secondary-btn">Don't have an account? Sign Up</button>
          </form>

          <form id="signup-form" style="display: none;">
              <input type="text" id="signup-username" placeholder="Username" required />
              <input type="password" id="signup-password" placeholder="Password" required />
              <select id="signup-role" class="w-full p-3 mb-4 border rounded-lg bg-gray-800 text-white">
                  <option value="normal">public user</option>
                  <option value="scientist">Scientist</option>
              </select>
              <div id="signup-message" class="text-red-500 text-sm mt-2 min-h-[1.5rem]"></div>
              <button type="submit" class="primary-btn">Sign Up</button>
              <button type="button" id="show-login-btn" class="secondary-btn">Already have an account? Login</button>
          </form>
      </div>
  </div>

  <script>
    // Ensure DOM is fully loaded before adding event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // --- Page Navigation Logic (Original) ---
      const heroSection = document.getElementById('hero-section');
      const newAsteroidContainer = document.querySelector('.new-asteroid-container');
      const infoCards = document.getElementById('info-cards');
      const secondPage = document.getElementById('second-page');
      const thirdPage = document.getElementById('third-page');
      const mainTitle = document.getElementById('main-title');
      const footer = document.querySelector('footer');
      const scientistExclusiveContent = document.getElementById('scientist-exclusive-content');
      const simulationTool = document.getElementById('simulation-tool'); // Get simulation tool section
      const asteroidMapSection = document.getElementById('asteroid-map-section'); // New section
      const mitigationMapSection = document.getElementById('mitigation-map-section'); // New section
      const impactor2025Section = document.getElementById('impactor-2025-section'); // New Impactor 2025 section
      const deflectionStrategiesDropdown = document.getElementById('deflection-strategies-dropdown');
      const mitigationStrategiesDropdown = document.getElementById('mitigation-strategies-dropdown');


      function hideAllContentSections() {
        heroSection.style.display = 'none';
        newAsteroidContainer.style.display = 'none';
        infoCards.style.display = 'none';
        secondPage.style.display = 'none';
        thirdPage.style.display = 'none';
        scientistExclusiveContent.style.display = 'none';
        simulationTool.style.display = 'none'; // Hide simulation tool
        asteroidMapSection.style.display = 'none'; // Hide asteroid map
        mitigationMapSection.style.display = 'none'; // Hide mitigation map
        impactor2025Section.style.display = 'none'; // Hide Impactor 2025 section
        // The dropdown wrappers are now always visible within the third page,
        // but their content will be reset.
      }

      function showMainPageSections() {
        hideAllContentSections();
        heroSection.style.display = 'flex';
        newAsteroidContainer.style.display = 'flex';
        updateUI(); // Re-evaluate scientist content visibility
      }

      function showSecondPage() {
        hideAllContentSections();
        secondPage.style.display = 'block';
        populateSecondPageCards(); // Populate cards when showing the second page
      }

      function showThirdPage(asteroidName) {
        hideAllContentSections();
        thirdPage.style.display = 'flex'; // Third page uses flex
        updateThirdPageContent(asteroidName);
        // Reset dropdowns and their details when navigating to a new asteroid
        document.getElementById('deflection-strategy-select').value = '';
        document.getElementById('deflection-strategy-details').style.display = 'none';
        document.getElementById('mitigation-strategy-select').value = '';
        document.getElementById('mitigation-strategy-details').style.display = 'none';
        // Hide video when navigating to a new asteroid
        const deflectionVideoContainer = document.getElementById('deflection-strategy-video-container');
        const deflectionVideo = deflectionVideoContainer.querySelector('video');
        deflectionVideoContainer.style.display = 'none';
        deflectionVideo.pause();
        deflectionVideo.removeAttribute('src');
      }

      function showSimulationTool() {
        hideAllContentSections();
        simulationTool.style.display = 'block';
      }

      function showAsteroidMap() {
        hideAllContentSections();
        asteroidMapSection.style.display = 'flex'; // Asteroid map uses flex
        // Re-initialize or update the asteroid map if needed
        if (typeof initAsteroidMap === 'function') {
            // Ensure previous animation is stopped and re-initialize
            if (typeof asteroidMapAnimationId !== 'undefined') {
                cancelAnimationFrame(asteroidMapAnimationId);
                asteroidMapAnimationId = undefined;
            }
            initAsteroidMap();
        }
      }

      function showMitigationMap() {
        hideAllContentSections();
        mitigationMapSection.style.display = 'block'; // Mitigation map uses block
        // Re-initialize or update the mitigation map if needed
        if (typeof initMitigationMap === 'function') {
            // Ensure previous animation is stopped and re-initialize
            if (typeof mitigationMapAnimationId !== 'undefined') {
                cancelAnimationFrame(mitigationMapAnimationId);
                mitigationMapAnimationId = undefined;
            }
            initMitigationMap();
        }
      }

      function showImpactor2025() {
        hideAllContentSections();
        impactor2025Section.style.display = 'block'; // Impactor 2025 section uses block
        // Initialize the Impactor 2025 Three.js scene
        if (typeof impactor2025Module !== 'undefined' && typeof impactor2025Module.init === 'function') {
            impactor2025Module.init();
        }
      }

      // Initial state: show main page sections (will be overridden by gate if not logged in)
      // showMainPageSections(); // This will be called after login/initial check

      document.getElementById('learn-more-btn').addEventListener('click', showSecondPage);
      document.getElementById('back-to-main-btn').addEventListener('click', showMainPageSections);
      document.querySelector('#third-page .back-btn').addEventListener('click', showSecondPage);

      // Header button event listeners
      document.getElementById('simulation-tool-btn').addEventListener('click', showSimulationTool);
      document.getElementById('asteroid-map-btn').addEventListener('click', showAsteroidMap);
      document.getElementById('mitigation-map-btn').addEventListener('click', showMitigationMap);

      // Return to Home Page buttons
      document.getElementById('simulation-return-home-btn').addEventListener('click', showMainPageSections);
      document.getElementById('asteroid-map-return-home-btn').addEventListener('click', showMainPageSections);
      document.getElementById('mitigation-map-return-home-btn').addEventListener('click', showMainPageSections);

      // New button for Hypothetical Simulation (now points to Impactor 2025 section)
      document.getElementById('hypothetical-simulation-btn').addEventListener('click', showImpactor2025);

      // Add event listener for the "Back to Main Page" button within the Impactor 2025 section
      document.getElementById('impactor-2025-section').querySelector('#backToMain').addEventListener('click', showMainPageSections);


      // --- Asteroid Details Data ---
      const asteroidDetails = {
        "Apophis": {
          title: "99942 Apophis",
          image: "https://res.cloudinary.com/dnm8wfn38/image/upload/v1759526061/apophiss_f3a8ll.png",
          description_public: `Nicknamed after the Egyptian god of chaos. In 2004, scientists thought it might hit Earth on Friday, April 13, 2029. It's about 450 meters long and will pass closer than some satellites. NASA's OSIRIS-APEX spacecraft is en route to meet it after the flyby.`,
          description_scientist: `Classification: Near Earth Object (NEO), Potentially Hazardous Asteroid (PHA).
- Size & Shape: elongated, irregular; effective diameter ~330375 m; long axis ~450 m (from radar/thermal models).
-	Rotation: non principal axis (tumbling) rotation; ~30.5 hours.
-	Closest Approach: April 13, 2029  ~32,00038,000 km (closer than geostationary orbit).
-	Risk: No impact risk for at least 100 years based on updated orbital solutions.
-	Science: Close flyby offers rare opportunity for detailed characterization; multiple missions and observing campaigns planned.
- Nicknamed after the Egyptian god of chaos.
-	In 2004, scientists thought it might hit Earth on Friday, April 13, 2029.
-	Size: ~450 meters long  bigger than the Empire State Building laid sideways.
-	Will pass closer than some satellites  just 20,000 miles above Earth.
-	NASA's OSIRIS-APEX spacecraft is en route to meet it after the flyby (a'cosmic handshake').

Sources:
-	NASA Science  Apophis Facts    https://science.nasa.gov/solar-system/asteroids/apophis-facts/
-	JPL CNEOS  Apophis    https://cneos.jpl.nasa.gov/
-	JPL SBDB  99942 Apophis    https://ssd.jpl.nasa.gov/tools/sbdb_lookup.html#/?sstr=99942
-	ESA  Planetary Defence: Apophis    https://www.esa.int/Space_Safety/Planetary_Defence/Apophis`
        },
        "2008 TC3": {
          title: "2008 TC3",
          image: "https://res.cloudinary.com/dnm8wfn38/image/upload/v1759526089/chic_kvlsmi.png",
          description_public: `Discovered just 19 hours before it hit Earth, this 4-meter asteroid exploded over Sudan's Nubian Desert on Oct 7, 2008. It was the first asteroid ever tracked from space to ground impact, and scientists recovered over 600 meteorite fragments.`,
          description_scientist: `Basic Identity
-	Event: First asteroid discovered before impact; entered atmosphere on Oct 7, 2008 and exploded ~37 km above the Nubian Desert, Sudan.
-	Entry Speed & Angle: ~12.8 km/s; shallow angle (~21).
-	Recovery: Meteorite fragments (Almahata Sitta) recovered; ureilite-rich, with nanodiamonds.
-	Significance: Milestone for planetary defence  pre impact detection, trajectory prediction, and sample recovery.

- Discovered just 19 hours before it hit Earth  last-minute drama!
-	Exploded over Sudan's Nubian Desert on Oct 7, 2008, lighting up the sky like a full moon.
-	Only 4 meters wide  school-bus sized  but packed a punch: ~1 kiloton of TNT.
- First asteroid ever tracked from space to ground impact.
- Scientists recovered 600+ meteorite fragments, including rare nanodiamond-rich ureilites.

  ReSources:
-	ESA NEO  Past impactors: 2008 TC3    https://neo.ssa.esa.int/past-impactors/2008tc3
-	Wikipedia  2008 TC3    https://en.wikipedia.org/wiki/2008_TC3
-	Nature (2009)  Almahata Sitta meteorites    https://www.nature.com/articles/nature07920
-	NASA NTRS  Trajectory  HYPERLINK "https://ntrs.nasa.gov/citations/20190000232"& HYPERLINK "https://ntrs.nasa.gov/citations/20190000232" analysis    https://ntrs.nasa.gov/citations/20190000232`
        },
        "Bennu": {
          title: "Bennu",
          image: "https://res.cloudinary.com/dnm8wfn38/image/upload/v1759526014/Screenshot_2025-10-04_000256_boxgan.png",
          description_public: `Bennu is a carbon-rich asteroid, about 500 meters in diameter. It's a Potentially Hazardous Asteroid with a small chance of impacting Earth in the late 22nd century. NASA's OSIRIS-REx spacecraft visited Bennu and returned samples to Earth, providing insights into the early solar system.`,
          description_scientist: `Basic Identity
- Type: Carbonaceous asteroid (B-type), rich in organic compounds
- Group: Apollo-class Near-Earth Object (NEO)
- Size: ~565  535  508 meters  roughly the height of the Empire State Building
- Mass: ~73.3 billion kg
- Density: ~1.19 g/cm  relatively porous
- Surface Gravity: ~6.27 micro-g (you could leap like a superhero)
- Escape Velocity: ~20 cm/s  you could literally jump off it

Origin & Composition
- Bennu likely formed in the Main Asteroid Belt between Mars and Jupiter
- Its a fragment from a much larger parent body that broke apart 700 million to 2 billion years ago
- Rich in carbon, hydrated minerals, and organic molecules  making it a prime candidate for studying the building blocks of life
- Surface temperature ranges from 37C to +6C, with no atmosphere or liquid water

Orbit & Rotation
- Orbital Period: ~1.2 Earth years
- Distance from Sun: ~168 million km (slightly farther than Earth)
- Inclination: ~6  tilted slightly compared to Earths orbit
- Rotation Period: ~4.3 hours  it spins fast
- Close Approaches: Comes near Earth every 6 years, sometimes within 186,000 miles (299,000 km)

Impact Risk
- Bennu is classified as a Potentially Hazardous Asteroid (PHA)
- Its listed on NASAs Sentry Risk Table and ranks second on the Palermo Technical Impact Hazard Scale
- Most notable potential impact: September 24, 2182  with a very small chance of collision
- Earth Minimum Orbit Intersection Distance (MOID): ~482,000 km  close enough to keep scientists alert

Where Could It Hit? :
NASA hasnt pinpointed an exact impact location  because it depends on how Earths gravity alters Bennus orbit during its close flyby in 2135. That encounter will shift its trajectory, and scientists are using OSIRIS-REx data to model thousands of possible outcomes.
If Bennu were to hit Earth, the impact zone would depend on:
-	The angle and speed of entry
-	Earths rotation at the time
-	Orbital perturbations from the 2135 flyby

Impact Zone Range :
- Theoretical models suggest a global range of possible impact corridors, spanning from the Pacific Ocean to parts of North and South America, Africa, and Asia  but these are not predictions, just simulations of possible paths.

Impact Consequences :
- Bennu is large enough to cause regional devastation, not global extinction.
- Estimated energy release: ~1,200 megatons of TNT  far more than any nuclear weapon ever detonated.
- It could create a crater ~510 km wide, depending on terrain and angle.

OSIRIS-REx Mission Highlights :
- Mission Launch: September 2016
- Arrival at Bennu: December 3, 2018
- Sample Collection: October 2020  using a Touch-and-Go maneuver
- Return to Earth: September 2023
- Sample Mass Returned: ~250 grams  the largest sample from an asteroid ever collected
- The mission revealed Bennus surface is much looser and more rugged than expected, with boulder fields and particle ejections

Name & Mythology :
- Named after the Bennu bird, an ancient Egyptian deity linked to the Sun, creation, and rebirth  fitting for an object that holds clues to the origin of life
- The name was chosen by Michael Puzio, a 9-year-old who won NASAs naming contest in 2013

Scientific Significance :
- Bennus material is unaltered since the Solar Systems formation, making it a pristine sample for studying planetary evolution
- The returned samples are being analyzed for amino acids, water-bearing minerals, and prebiotic chemistry
- Its a key target for understanding how asteroids could deliver life-building materials to Earth

RESOURCES :
-	101955 Bennu - Wikipedia
-	Bennu 
-	NASA Spacecraft Provides Insight into Asteroid Bennus Future Orbit | NASA Jet Propulsion Laboratory (JPL)`
        },
        "Chelyabinsk": {
          title: "Chelyabinsk",
          image: "https://res.cloudinary.com/dnm8wfn38/image/upload/v1759526351/Screenshot_2025-10-04_001842_cw44rs.png",
          description_public: `On February 15, 2013, a meteor exploded over Chelyabinsk, Russia, with the energy of 400-500 kilotons of TNT. It shattered windows and injured over 1,400 people, highlighting the threat of undetected asteroids.`,
          description_scientist: `Overview of the Event
- Date & Time: February 15, 2013, at 09:20 local time (YEKT)
- Location: Chelyabinsk Oblast, Russia  near the city of Chebarkul
- Object Type: A near-Earth asteroid, classified as a superbolide (an exceptionally bright meteor)
- Size: ~1720 meters in diameter (about the size of a six-story building)
- Mass: Estimated between 7,000 to 10,000 tons
- Speed: ~19.16 km/s (68,980 km/h or 42,860 mph)

	 Explosion & Impact :
- The meteor entered Earths atmosphere at a shallow 18-degree angle, exploding at an altitude of ~30 km (18.6 miles).
- The blast released energy equivalent to 400500 kilotons of TNT  about 30 times the Hiroshima bomb.
- The explosion created a shockwave that shattered windows, collapsed roofs, and damaged over 7,200 buildings across six cities.
- 1,491 people were injured  mostly from flying glass and debris

    Visual & Atmospheric Effects :
- The meteors flash was brighter than the Sun, visible up to 100 km away.
-	 Eyewitnesses reported feeling intense heat from the fireball.
-	 The explosion produced a hot cloud of dust and gas, penetrating down to 26 km altitude.
-	 Fragments of the meteor were recovered, including a large piece from Lake Chebarkul.

    Why It Was So Well-Documented :
- Thanks to Russias widespread use of dashboard cameras, the event was captured from multiple angles.
-	 Videos show the fireball streaking across the sky, followed by a delayed sonic boom that shattered windows.

  	Scientific & Global Response :
-	 The meteor approached undetected, partly because it came from a direction near the Sun  making it hard for telescopes to spot.
-	 The same day, another asteroid (2012 DA14) passed close to Earth, but it was unrelated.
-	 The event prompted NASA and other agencies to accelerate planetary defense efforts, including the creation of the Planetary Defense Coordination Office

    Legacy & Lessons :
- Largest known natural object to enter Earths atmosphere since the Tunguska event in 1908.
- First confirmed meteor to cause human injuries.
- Sparked global awareness of the need to track and prepare for near-Earth objects.

	RESOURCES :
-	Photos: Russian Meteor Explosion of Feb. 15 | Space
-	Chelyabinsk Meteor: A Wake-Up Call for Earth | Space`
        },
        "Theia": {
          title: "Theia",
          image: "https://res.cloudinary.com/dnm8wfn38/image/upload/v1759526008/Screenshot_2025-10-04_001312_mmmhtc.png",
          description_public: `Theia is a hypothetical ancient planet that collided with early Earth, forming the Moon. Remnants of Theia may still exist deep within Earths mantle.`,
          description_scientist: `Theia is a hypothesized Mars-sized protoplanet that collided with the early Earth about 4.5 billion years ago. This giant impact is believed to have formed the Moon. Simulations suggest the Moon may have formed in mere hours from debris launched into orbit. Isotopic similarities between Earth and Moon rocks support this theory, indicating much of the Moons material came from Earth. Remnants of Theia may still exist deep within Earths mantle, beneath Africa and the Pacific Ocean, as dense regions known as LLVPs (Large Low-Shear Velocity Provinces). Source: NASA Ames Research Center, GRAIL mission data  https://www.nasa.gov/solar-system/collision-may-have-formed-the-moon-in-mere-hours-simulations-reveal/`
        },
        "Pallas": {
          title: "Pallas (2 Pallas)",
          image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/15b5384a-8d06-4353-8ac3-b0a1a322e190.png",
          description_public: `Pallas is the third-largest asteroid in the Solar System, about 512 km in diameter. It has a highly inclined orbit and is considered a remnant protoplanet from the early Solar System.`,
          description_scientist: `Pallas is the third-largest asteroid in the Solar System and orbits in the central asteroid belt. Discovered in 1802, it measures about 512 km in diameter and has a highly inclined orbit (34.8). Its classified as a B-type asteroid, indicating a composition rich in silicates and possibly hydrated minerals. Pallas is considered a remnant protoplanet from the early Solar System and has a mass of approximately 2.04  10 kg. Its surface gravity is about 0.21 m/s, and it rotates every 7.81 hours. Source: NASA Small-Body Database  https://ssd.jpl.nasa.gov/tools/sbdb_lookup.html`
        },
        "Itokawa": {
          title: "Itokawa (25143 Itokawa)",
          image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/40c72ef7-de95-489b-ba88-ca6a192f6df3.png",
          description_public: `Itokawa is a small, peanut-shaped near-Earth asteroid, about 535 meters long. Japans Hayabusa spacecraft returned samples from it, revealing it to be a rubble pile asteroid.`,
          description_scientist: ` Itokawa (25143 Itokawa)
Itokawa is a small, peanut-shaped near-Earth asteroid, about 535 meters long. It was visited by Japans Hayabusa spacecraft in 2005, which returned samples to Earth in 2010. Itokawa is an S-type asteroid and is believed to be a rubble pilea loose collection of rocks held together by gravity. Analysis of its dust confirmed that Itokawa originated from a larger parent body that was shattered. Its orbit crosses those of Earth and Mars, and its surface shows few craters due to its loose structure. Source: NASA Science Solar System Exploration  https://science.nasa.gov/solar-system/asteroids/25143-itokawa/`
        },
        "Ceres": {
          title: "Ceres (1 Ceres)",
          image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/9a4cbbd4-890a-4863-9ae7-4861caa042fb.png",
          description_public: `Ceres is the largest object in the asteroid belt and a dwarf planet, with a diameter of about 940 km. NASAs Dawn mission revealed it has a water-rich crust and bright surface spots.`,
          description_scientist: `Ceres is the largest object in the asteroid belt and was reclassified as a dwarf planet in 2006. It has a diameter of about 940 km and contains around 35% of the asteroid belts total mass. NASAs Dawn mission revealed that Ceres has a water-rich crust, internal differentiation, and bright surface spots made of salts. Evidence of water vapor and ammonia suggests Ceres may have originated in the outer solar system. Geological activity may still be occurring due to subsurface brines. Source: NASA Dawn Mission  https://science.nasa.gov/mission/dawn/science/ceres/`
        }
      };

      function updateThirdPageContent(asteroidName) {
        const data = asteroidDetails[asteroidName];
        if (data) {
          document.getElementById('third-page-title').innerHTML = data.title.split(' ')[0] + '<br /><span>' + data.title.split(' ').slice(1).join(' ') + '</span>';
          document.getElementById('third-page-image').src = data.image;
          document.getElementById('third-page-image').alt = `Image of ${data.title}`;
          
          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.role === 'scientist') {
            document.getElementById('third-page-description').textContent = data.description_scientist;
          } else {
            document.getElementById('third-page-description').textContent = data.description_public;
          }
        } else {
          // Fallback for unknown asteroids
          document.getElementById('third-page-title').innerHTML = 'Unknown<br /><span>Asteroid</span>';
          document.getElementById('third-page-image').src = 'https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg'; // Default image
          document.getElementById('third-page-image').alt = 'Default asteroid image';
          document.getElementById('third-page-description').textContent = 'Details for this asteroid are not available yet.';
        }
      }

      // Function to dynamically populate asteroid cards
      function populateSecondPageCards() {
        const secondPageCardsContainer = document.getElementById('second-page-cards');
        secondPageCardsContainer.innerHTML = ''; // Clear existing cards

        for (const asteroidName in asteroidDetails) {
          const data = asteroidDetails[asteroidName];
          const cardHtml = `
            <article class="card flex flex-col items-center p-4 text-white shadow-lg" data-asteroid="${asteroidName}">
              <div class="card-image-wrapper">
                <img src="${data.image}" alt="3D asteroid named ${asteroidName}" onerror="this.style.display='none';" />
                <div class="card-hover-overlay" aria-hidden="true">
                  <button class="card-hover-btn" type="button">wanna know more ?</button>
                </div>
              </div>
              <h3 class="mt-3 text-xl font-bold">${data.title}</h3>
            </article>
          `;
          secondPageCardsContainer.insertAdjacentHTML('beforeend', cardHtml);
        }

        // Re-attach event listeners to the newly created buttons
        const newKnowMoreButtons = document.querySelectorAll('#second-page-cards .card-hover-btn');
        newKnowMoreButtons.forEach(btn => {
          btn.addEventListener('click', (event) => {
            const card = event.target.closest('.card');
            const asteroidName = card.dataset.asteroid;
            showThirdPage(asteroidName);
          });
        });
      }

      // Call populateSecondPageCards initially to ensure they are there if the page is directly accessed
      // This will be called again when showSecondPage is triggered.
      populateSecondPageCards();


      // --- Chatbot Logic ---
      const chatbotBtn = document.getElementById('chatbot-btn');
      const chatbotModal = document.getElementById('chatbot-modal');
      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const chatSendBtn = document.getElementById('chat-send-btn');

      const asteroidKnowledge = {
        "new asteroid": "The new asteroid under study is 2025VX1, also known as IMPACTOR 2025.",
        "2025vx1": "Asteroid 2025VX1 (IMPACTOR 2025) is currently under study. Its estimated size is 500 meters in diameter.",
        "impactor 2025": "IMPACTOR 2025 (2025VX1) is an asteroid under study, estimated to be 500 meters in diameter.",
        "size of 2025vx1": "The estimated size of asteroid 2025VX1 is 500 meters in diameter.",
        "potential impact of 2025vx1": "The potential impact of 2025VX1 may produce cataclysmic effects like tremendous shockwaves, tsunamis, and worldwide climatic disruption from the sun's blockage due to dust and debris.",
        "apophis": asteroidDetails["Apophis"].description_public, // Use public description for chatbot
        "2008 tc3": asteroidDetails["2008 TC3"].description_public,
        "bennu": asteroidDetails["Bennu"].description_public,
        "chelyabinsk": asteroidDetails["Chelyabinsk"].description_public,
        "theia": asteroidDetails["Theia"].description_public,
        "pallas": asteroidDetails["Pallas"].description_public,
        "itokawa": asteroidDetails["Itokawa"].description_public,
        "ceres": asteroidDetails["Ceres"].description_public,
        "what are asteroids": "Asteroids are rocky objects that orbit the Sun. This explorer focuses on potential impacts.",
        "cosmic impact explorer": "The Cosmic Impact Explorer is a platform to explore asteroids and potential impacts.",
        "the final smashers": "The Final Smashers is the name of the entity behind this Cosmic Impact Explorer.",
        "invisible forces": "The 'Invisible Forces' section discusses general concepts, but the specific content is placeholder text (Lorem ipsum).",
        "default": "I can only answer questions related to the asteroids mentioned on this website (e.g., 2025VX1, Apophis, 2008 TC3, Bennu, etc.) or general information presented here. Please ask about a specific asteroid or topic from the page."
      };

      chatbotBtn.addEventListener('click', () => {
        chatbotModal.style.display = chatbotModal.style.display === 'flex' ? 'none' : 'flex';
        if (chatbotModal.style.display === 'flex') {
          chatInput.focus();
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      });

      function addMessage(text, sender) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}`;
        msgDiv.textContent = text;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function getAIResponse(userMessage) {
        const lowerMsg = userMessage.toLowerCase();
        let response = asteroidKnowledge.default;

        for (const keyword in asteroidKnowledge) {
          if (lowerMsg.includes(keyword.toLowerCase())) { // Case-insensitive matching
            response = asteroidKnowledge[keyword];
            break;
          }
        }
        return response;
      }

      function sendMessage() {
        const userText = chatInput.value.trim();
        if (userText === '') return;

        addMessage(userText, 'user');
        chatInput.value = '';

        setTimeout(() => {
          const botResponse = getAIResponse(userText);
          addMessage(botResponse, 'bot');
        }, 700);
      }

      chatSendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // --- Authentication Gate Logic ---
      const gateModal = document.getElementById('gate-modal');
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const showSignupBtn = document.getElementById('show-signup-btn');
      const showLoginBtn = document.getElementById('show-login-btn');
      const loginSignupBtn = document.getElementById('login-signup-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const userInfoDiv = document.getElementById('user-info');
      const displayUsernameSpan = document.getElementById('display-username');
      const displayRoleSpan = document.getElementById('display-role');
      const mainContentWrapper = document.getElementById('main-content-wrapper');
      const body = document.body;

      let users = JSON.parse(localStorage.getItem('users')) || {};
      let currentUser = JSON.parse(localStorage.getItem('currentUser'));

      function updateUI() {
        if (currentUser) {
          body.classList.remove('logged-out');
          mainContentWrapper.style.display = 'block'; // Show main content
          loginSignupBtn.style.display = 'none';
          userInfoDiv.style.display = 'flex';
          displayUsernameSpan.textContent = currentUser.username;
          displayRoleSpan.textContent = currentUser.role === 'scientist' ? 'Scientist' : 'Public User';
          chatbotBtn.style.display = 'flex'; // Show chatbot

          // Show scientist-exclusive content ONLY if role is scientist AND we are on the main page view
          if (currentUser.role === 'scientist' &&
              heroSection.style.display !== 'none' &&
              newAsteroidContainer.style.display !== 'none' &&
              secondPage.style.display === 'none' &&
              thirdPage.style.display === 'none' &&
              simulationTool.style.display === 'none' && // Also check simulation tool
              asteroidMapSection.style.display === 'none' && // Also check asteroid map
              mitigationMapSection.style.display === 'none' && // Also check mitigation map
              impactor2025Section.style.display === 'none' // Also check impactor 2025 section
              ) {
            scientistExclusiveContent.style.display = 'block';
          } else {
            scientistExclusiveContent.style.display = 'none';
          }
        } else {
          body.classList.add('logged-out');
          mainContentWrapper.style.display = 'none'; // Hide main content
          loginSignupBtn.style.display = 'block';
          userInfoDiv.style.display = 'none';
          chatbotBtn.style.display = 'none'; // Hide chatbot
          scientistExclusiveContent.style.display = 'none'; // Hide scientist content
        }
      }

      function showGate(formType = 'login') {
        gateModal.style.display = 'flex';
        if (formType === 'login') {
          document.getElementById('gate-title').textContent = 'Login';
          loginForm.style.display = 'block';
          signupForm.style.display = 'none';
          document.getElementById('login-message').textContent = '';
          document.getElementById('login-username').value = '';
          document.getElementById('login-password').value = '';
        } else {
          document.getElementById('gate-title').textContent = 'Sign Up';
          loginForm.style.display = 'none';
          signupForm.style.display = 'block';
          document.getElementById('signup-message').textContent = '';
          document.getElementById('signup-username').value = '';
          document.getElementById('signup-password').value = '';
          document.getElementById('signup-role').value = 'normal';
        }
      }

      function hideGate() {
        gateModal.style.display = 'none';
      }

      // Event Listeners for Gate
      loginSignupBtn.addEventListener('click', () => showGate('login'));
      logoutBtn.addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem('currentUser');
        updateUI();
        showGate('login'); // Show login gate after logout
      });

      showSignupBtn.addEventListener('click', (e) => {
        e.preventDefault(); // Prevent form submission if it's a button inside a form
        showGate('signup');
      });
      showLoginBtn.addEventListener('click', (e) => {
        e.preventDefault(); // Prevent form submission if it's a button inside a form
        showGate('login');
      });

      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const loginMessage = document.getElementById('login-message');

        if (users[username] && users[username].password === password) {
          const oldRole = currentUser ? currentUser.role : null;
          currentUser = { username: username, role: users[username].role };
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          hideGate();
          
          // If role changed, force a reload to ensure all maps/tools reset
          if (oldRole !== currentUser.role) {
            location.reload();
          } else {
            updateUI();
            showMainPageSections(); // Ensure main page is shown after login
          }
        } else {
          loginMessage.textContent = 'Invalid username or password.';
        }
      });

      signupForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('signup-username').value;
        const password = document.getElementById('signup-password').value;
        const role = document.getElementById('signup-role').value;
        const signupMessage = document.getElementById('signup-message');

        if (users[username]) {
          signupMessage.textContent = 'Username already exists.';
        } else {
          users[username] = { password: password, role: role };
          localStorage.setItem('users', JSON.stringify(users));
          signupMessage.textContent = 'Sign up successful! Please log in.';
          signupMessage.style.color = '#22c55e'; // Green for success
          setTimeout(() => showGate('login'), 1500); // Show login form after signup
        }
      });

      // --- Earth Planet Eye Logic ---
      const loginPasswordInput = document.getElementById('login-password');
      const earthEyelid = document.getElementById('earth-eyelid');

      if (loginPasswordInput && earthEyelid) {
        loginPasswordInput.addEventListener('focus', () => {
          earthEyelid.classList.add('password-active');
        });

        loginPasswordInput.addEventListener('blur', () => {
          earthEyelid.classList.remove('password-active');
        });
      }

      // --- Simulation Tool Logic ---
      const runSimulationBtn = document.getElementById('run-simulation-btn');
      const asteroidSizeInput = document.getElementById('asteroid-size');
      const asteroidVelocityInput = document.getElementById('asteroid-velocity');
      const targetTypeSelect = document.getElementById('target-type');
      const simulationResultsDiv = document.getElementById('simulation-results');
      const resultEnergy = document.getElementById('result-energy');
      const resultCrater = document.getElementById('result-crater');
      const resultEjecta = document.getElementById('result-ejecta');
      const resultEffects = document.getElementById('result-effects');

      runSimulationBtn.addEventListener('click', () => {
        const size = parseFloat(asteroidSizeInput.value); // meters
        const velocity = parseFloat(asteroidVelocityInput.value) * 1000; // km/s to m/s
        const target = targetTypeSelect.value;

        if (isNaN(size) || isNaN(velocity) || size <= 0 || velocity <= 0) {
          alert('Please enter valid positive numbers for asteroid size and velocity.');
          return;
        }

        // Simplified impact physics (for demonstration)
        // Mass (assuming average asteroid density ~2500 kg/m^3)
        // Volume of a sphere: (4/3) * pi * r^3
        const radius = size / 2;
        const volume = (4/3) * Math.PI * Math.pow(radius, 3);
        const density = 2500; // kg/m^3
        const mass = density * volume; // kg

        // Kinetic Energy: 0.5 * m * v^2 (Joules)
        const energyJoules = 0.5 * mass * Math.pow(velocity, 2);
        const energyMegatons = energyJoules / (4.184 * Math.pow(10, 15)); // Convert Joules to Megatons of TNT

        let craterDiameter = 0; // meters
        let ejectaBlanket = '';
        let potentialEffects = '';

        if (target === 'land') {
          // Empirical formula for crater diameter on land (simplified)
          // D  1.2 * (E / g)^(1/3) where E is energy in Joules, g is gravity (9.8 m/s^2)
          craterDiameter = 1.2 * Math.pow(energyJoules / 9.8, 1/3); // Very rough estimate
          craterDiameter = Math.min(craterDiameter, size * 50); // Cap crater size relative to asteroid for realism
          craterDiameter = Math.max(craterDiameter, size * 5); // Minimum crater size

          if (size < 100) {
            potentialEffects = 'Local damage, small crater, air blast.';
            ejectaBlanket = 'Localized around impact site.';
          } else if (size < 500) {
            potentialEffects = 'Regional devastation, significant crater, seismic activity, dust cloud.';
            ejectaBlanket = 'Extends tens to hundreds of kilometers.';
          } else {
            potentialEffects = 'Global climatic disruption, massive crater, widespread seismic activity, tsunamis (if near coast), long-term atmospheric effects.';
            ejectaBlanket = 'Global distribution of fine dust.';
          }
        } else { // Ocean impact
          // Ocean impacts are more complex, focus on tsunami generation
          craterDiameter = 0; // Transient crater, quickly collapses
          if (size < 100) {
            potentialEffects = 'Large splash, localized waves.';
            ejectaBlanket = 'Water vapor and spray.';
          } else if (size < 500) {
            potentialEffects = 'Significant tsunamis affecting coastal regions, atmospheric steam.';
            ejectaBlanket = 'Widespread water vapor and sea spray.';
          } else {
            potentialEffects = 'Catastrophic mega-tsunamis, global atmospheric effects from steam and salt, potential for climate change.';
            ejectaBlanket = 'Global atmospheric distribution of water and salt.';
          }
        }

        resultEnergy.textContent = `${energyMegatons.toExponential(2)} Megatons of TNT`;
        resultCrater.textContent = `${craterDiameter.toFixed(2)} meters (approximate)`;
        resultEjecta.textContent = ejectaBlanket;
        resultEffects.textContent = potentialEffects;

        simulationResultsDiv.style.display = 'block';
      });

      // --- Deflection and Mitigation Strategies Data ---
      const deflectionStrategies = {
        "kinetic_impactor": {
          name: "Kinetic Impactor",
          description: "A spacecraft is deliberately crashed into the asteroid to alter its velocity and trajectory. This method is most effective for smaller asteroids and requires significant lead time.",
          pros: "Relatively mature technology, direct physical interaction, can be tested.",
          cons: "Requires long lead time, effectiveness decreases with asteroid size, risk of fragmentation, precise targeting needed.",
          status: "Demonstrated (DART mission)",
          video: "https://res.cloudinary.com/dnm8wfn38/video/upload/v1759549062/kinetic_bbslyc.mp4"
        },
        "gravity_tractor": {
          name: "Gravity Tractor",
          description: "A heavy spacecraft flies alongside the asteroid for an extended period, using its gravitational pull to subtly tug the asteroid off course. This is a slow but precise method.",
          pros: "Very precise, no physical contact (avoids fragmentation), works for various asteroid compositions.",
          cons: "Requires very long lead time (years to decades), complex station-keeping, limited by spacecraft mass.",
          status: "Theoretical, under study",
          video: "https://res.cloudinary.com/dnm8wfn38/video/upload/v1759549068/gravity_swpmb5.mp4"
        },
        "nuclear_detonation": {
          name: "Nuclear Detonation",
          description: "A nuclear device is detonated near (not on) the asteroid to ablate material from its surface, creating a thrust that pushes it off course. This is a last-resort option for large, short-notice threats.",
          pros: "Most powerful option, effective for large asteroids, shorter lead time than kinetic impactor for large objects.",
          cons: "High political and environmental risks, potential for asteroid fragmentation into radioactive pieces, unpredictable outcome.",
          status: "Theoretical, highly controversial",
          video: "https://res.cloudinary.com/dnm8wfn38/video/upload/v1759549052/necular_el3iq4.mp4"
        },
        "laser_ablation": {
          name: "Laser Ablation",
          description: "High-powered lasers are used to vaporize material from the asteroid's surface, creating a jet of gas that provides a small but continuous thrust. This method is still in early research phases.",
          pros: "Precise, no physical contact, can be adjusted over time.",
          cons: "Requires very high power lasers, slow process, limited by asteroid composition, technology is nascent.",
          status: "Early research",
          video: "" // No video for this one
        }
      };

      const mitigationStrategies = {
        "evacuation": {
          name: "Evacuation",
          description: "Moving populations from predicted impact zones to safer areas. This requires accurate impact prediction and significant logistical planning.",
          pros: "Directly saves lives, reduces casualties in predicted impact zones.",
          cons: "Logistically complex, costly, requires accurate prediction, can cause panic and social disruption.",
          status: "Standard disaster response"
        },
        "shelter_in_place": {
          name: "Shelter-in-Place",
          description: "Instructing people to remain indoors or in designated shelters to protect against immediate hazards like air blast, thermal radiation, or falling debris.",
          pros: "Faster to implement than evacuation, suitable for short-notice events or less severe impacts.",
          cons: "Limited protection against direct impact or severe hazards, requires robust infrastructure, psychological impact.",
          status: "Standard disaster response"
        },
        "infrastructure_hardening": {
          name: "Infrastructure Hardening",
          description: "Reinforcing critical buildings, utilities, and transportation networks to withstand impact effects. This is a long-term, preventative measure.",
          pros: "Reduces damage and speeds recovery, protects essential services.",
          cons: "Extremely costly, time-consuming, cannot protect against direct impact, requires foresight.",
          status: "Ongoing development"
        },
        "early_warning_systems": {
          name: "Early Warning Systems",
          description: "Developing and deploying advanced systems to detect, track, and characterize Near-Earth Objects (NEOs) as early as possible, providing crucial lead time for response.",
          pros: "Foundation for all other strategies, maximizes lead time, enables informed decision-making.",
          cons: "Requires continuous investment in telescopes and data analysis, not foolproof, can generate false alarms.",
          status: "Active development and deployment"
        }
      };

      const deflectionSelect = document.getElementById('deflection-strategy-select');
      const deflectionDetailsDiv = document.getElementById('deflection-strategy-details');
      const deflectionVideoContainer = document.getElementById('deflection-strategy-video-container');
      const deflectionVideo = deflectionVideoContainer.querySelector('video');

      const mitigationSelect = document.getElementById('mitigation-strategy-select');
      const mitigationDetailsDiv = document.getElementById('mitigation-strategy-details');

      function displayStrategyDetails(strategyType, selectedValue) {
        let detailsDiv;
        let strategiesData;

        if (strategyType === 'deflection') {
          detailsDiv = deflectionDetailsDiv;
          strategiesData = deflectionStrategies;

          // Handle video for deflection strategies
          if (selectedValue && strategiesData[selectedValue] && strategiesData[selectedValue].video) {
            deflectionVideo.src = strategiesData[selectedValue].video;
            deflectionVideoContainer.style.display = 'block';
            deflectionVideo.load(); // Load the video
            deflectionVideo.play(); // Autoplay
          } else {
            deflectionVideoContainer.style.display = 'none';
            deflectionVideo.pause();
            deflectionVideo.removeAttribute('src'); // Clear video source
          }

        } else if (strategyType === 'mitigation') {
          detailsDiv = mitigationDetailsDiv;
          strategiesData = mitigationStrategies;
        } else {
          return;
        }

        if (selectedValue && strategiesData[selectedValue]) {
          const strategy = strategiesData[selectedValue];
          detailsDiv.innerHTML = `
            <h3>${strategy.name}</h3>
            <p><strong>Description:</strong> ${strategy.description}</p>
            <p><strong>Pros:</strong> ${strategy.pros}</p>
            <p><strong>Cons:</strong> ${strategy.cons}</p>
            <p><strong>Status:</strong> ${strategy.status}</p>
          `;
          detailsDiv.style.display = 'block';
        } else {
          detailsDiv.innerHTML = '';
          detailsDiv.style.display = 'none';
        }
      }

      deflectionSelect.addEventListener('change', (event) => {
        displayStrategyDetails('deflection', event.target.value);
      });

      mitigationSelect.addEventListener('change', (event) => {
        displayStrategyDetails('mitigation', event.target.value);
      });


      // Initial check on page load
      updateUI();
      if (!currentUser) {
        showGate('login'); // If not logged in, show the gate immediately
      } else {
        showMainPageSections(); // If already logged in, show main content
      }
    }); // End DOMContentLoaded


    // --- Impactor 2025 Module (from impactor.html) ---
    const impactor2025Module = (function() {
        let scene, camera, renderer, asteroid, controls, sun, earth;
        let isRotating = true;
        let orbitAnimationId = null;
        let impactAnimationId = null;
        let currentMode = 'default'; // 'default', 'orbit', 'impact'
        let sunParticles = []; // Not used in the provided code, but kept for consistency

        // Scale factors for visualization (not to real scale for visibility)
        const SCALE = {
            SUN: 5,
            EARTH: 1.5,
            ASTEROID: 0.2,
            ORBIT: 15
        };
        
        // Orbital parameters (simulated from NASA NEO API)
        const orbitalParams = {
            semiMajorAxis: 1.82, // AU
            eccentricity: 0.42,
            inclination: 12.7, // degrees
            argumentOfPeriapsis: 145, // degrees
            longitudeOfAscendingNode: 75 // degrees
        };

        function init() {
            // Ensure the canvas exists before initializing Three.js
            const canvas = document.getElementById('solarSystemCanvas');
            if (!canvas) {
                console.error("solarSystemCanvas not found. Impactor 2025 module cannot initialize.");
                return;
            }

            // Clear previous scene if it exists
            if (scene) {
                scene.children.forEach(child => {
                    if (child.geometry) child.geometry.dispose();
                    if (child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(m => m.dispose());
                        } else {
                            child.material.dispose();
                        }
                    }
                    scene.remove(child);
                });
                renderer.dispose();
                controls.dispose();
            }

            // Create scene
            scene = new THREE.Scene();
            
            // Create camera
            camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 2000);
            camera.position.set(0, 20, 30);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 200;
            
            // Add galaxy background
            createGalaxyBackground();
            
            // Add advanced lighting
            setupLighting();
            
            // Create celestial bodies
            createSun();
            createEarth();
            
            // Create realistic asteroid
            createRealisticAsteroid();
            
            // Add some other planets for context
            createOtherPlatnets(); // Corrected typo from original
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start animation
            animate();
            
            // Simulate data updates
            simulateDataUpdates();

            // Set up button event handlers for this section
            document.getElementById('impactor-2025-section').querySelector('#simulateOrbit').addEventListener('click', simulateOrbit);
            document.getElementById('impactor-2025-section').querySelector('#impactScenario').addEventListener('click', simulateImpact);
            document.getElementById('impactor-2025-section').querySelector('#resetView').addEventListener('click', resetView);
        }

        function stopAnimations() {
            if (orbitAnimationId) {
                cancelAnimationFrame(orbitAnimationId);
                orbitAnimationId = null;
            }
            if (impactAnimationId) {
                cancelAnimationFrame(impactAnimationId);
                impactAnimationId = null;
            }
        }
        
        // Create galaxy background with stars and nebulas
        function createGalaxyBackground() {
            // Create starfield
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 20000;
            
            const positions = new Float32Array(starCount * 3);
            const colors = new Float32Array(starCount * 3);
            const sizes = new Float32Array(starCount);
            
            for (let i = 0; i < starCount; i++) {
                // Random position in a sphere - larger radius for full coverage
                const radius = 1500 + Math.random() * 1000;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                positions[i * 3] = radius * Math.sin(phi) * Math.cos(theta);
                positions[i * 3 + 1] = radius * Math.sin(phi) * Math.sin(theta);
                positions[i * 3 + 2] = radius * Math.cos(phi);
                
                // Random color (mostly white/blue with some variation)
                const color = new THREE.Color();
                color.setHSL(0.6 + Math.random() * 0.1, 0.2 + Math.random() * 0.3, 0.7 + Math.random() * 0.3);
                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
                
                // Random size
                sizes[i] = Math.random() * 2;
            }
            
            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            starGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            starGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            
            const starMaterial = new THREE.PointsMaterial({
                size: 1.5,
                vertexColors: true,
                sizeAttenuation: true
            });
            
            const stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
            
            // Add a few distant galaxies for more realism
            for (let i = 0; i < 5; i++) {
                const galaxyGeometry = new THREE.SphereGeometry(20 + Math.random() * 30, 8, 6);
                const galaxyMaterial = new THREE.MeshBasicMaterial({
                    color: new THREE.Color().setHSL(0.7 + Math.random() * 0.2, 0.5, 0.3 + Math.random() * 0.2),
                    transparent: true,
                    opacity: 0.3
                });
                
                const galaxy = new THREE.Mesh(galaxyGeometry, galaxyMaterial);
                
                // Position galaxies far away
                const galaxyRadius = 1200 + Math.random() * 300;
                const galaxyTheta = Math.random() * Math.PI * 2;
                const galaxyPhi = Math.acos(2 * Math.random() - 1);
                
                galaxy.position.set(
                    galaxyRadius * Math.sin(galaxyPhi) * Math.cos(galaxyTheta),
                    galaxyRadius * Math.sin(galaxyPhi) * Math.sin(galaxyTheta),
                    galaxyRadius * Math.cos(galaxyPhi)
                );
                
                scene.add(galaxy);
            }
        }
        
        // Set up advanced lighting for realism
        function setupLighting() {
            // Main directional light from the Sun
            const sunLight = new THREE.DirectionalLight(0xffffee, 1.5);
            sunLight.position.set(0, 0, 0);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 500;
            scene.add(sunLight);
            
            // Ambient light for general illumination
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            // Add directional light (sun)
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 3, 5);
            scene.add(directionalLight);
        }
        
        // Create the Sun as a clean sphere with solar flares
        function createSun() {
            const sunGeometry = new THREE.SphereGeometry(5.333, 213.333, 213.333);
            const sunMaterial = new THREE.MeshBasicMaterial({
                color: 0xFFFF00,
                transparent: true,
                opacity: 0.9
            });
            
            sun = new THREE.Mesh(sunGeometry, sunMaterial);
            sun.position.set(0, 0, 0);
            scene.add(sun);
            
            // Add solar flare effect using point light with glow
            const sunLight = new THREE.PointLight(0xFFFF00, 1.5, 50);
            sunLight.position.copy(sun.position);
            scene.add(sunLight);
        }
        
        // Create Earth with realistic blue oceans and green continents
        function createEarth() {
            const earthGeometry = new THREE.SphereGeometry(1, 32, 32);
            
            // Create custom Earth material with procedural colors
            const earthMaterial = new THREE.MeshPhongMaterial({
                specular: new THREE.Color(0x333333),
                shininess: 5
            });
            
            // Create a canvas texture for Earth with blue oceans and green continents
            const earthCanvas = document.createElement('canvas');
            earthCanvas.width = 1024;
            earthCanvas.height = 512;
            const earthCtx = earthCanvas.getContext('2d');
            
            // Fill with blue ocean color
            earthCtx.fillStyle = '#1E90FF';
            earthCtx.fillRect(0, 0, earthCanvas.width, earthCanvas.height);
            
            // Add green continent-like shapes
            earthCtx.fillStyle = '#228B22';
            
            // Draw some continent-like shapes (simplified)
            // North America
            earthCtx.beginPath();
            earthCtx.moveTo(250, 100);
            earthCtx.bezierCurveTo(300, 80, 350, 120, 400, 100);
            earthCtx.bezierCurveTo(450, 150, 350, 200, 300, 180);
            earthCtx.bezierCurveTo(250, 200, 200, 150, 250, 100);
            earthCtx.fill();
            
            // South America
            earthCtx.beginPath();
            earthCtx.moveTo(350, 250);
            earthCtx.bezierCurveTo(400, 230, 450, 280, 400, 350);
            earthCtx.bezierCurveTo(350, 400, 300, 350, 350, 250);
            earthCtx.fill();
            
            // Europe/Asia
            earthCtx.beginPath();
            earthCtx.moveTo(550, 100);
            earthCtx.bezierCurveTo(650, 80, 750, 150, 800, 120);
            earthCtx.bezierCurveTo(850, 200, 750, 300, 650, 250);
            earthCtx.bezierCurveTo(550, 200, 500, 150, 550, 100);
            earthCtx.fill();
            
            // Africa
            earthCtx.beginPath();
            earthCtx.moveTo(500, 200);
            earthCtx.bezierCurveTo(550, 180, 600, 220, 650, 200);
            earthCtx.bezierCurveTo(700, 300, 600, 400, 550, 350);
            earthCtx.bezierCurveTo(500, 300, 450, 250, 500, 200);
            earthCtx.fill();
            
            // Australia
            earthCtx.beginPath();
            earthCtx.moveTo(750, 350);
            earthCtx.bezierCurveTo(800, 330, 850, 370, 800, 420);
            earthCtx.bezierCurveTo(750, 450, 700, 400, 750, 350);
            earthCtx.fill();
            
            const earthTexture = new THREE.CanvasTexture(earthCanvas);
            earthMaterial.map = earthTexture;
            
            earth = new THREE.Mesh(earthGeometry, earthMaterial);
            earth.position.set(10, 0, 0);
            scene.add(earth);
            
            // Add a more realistic orbit line for Earth
            const orbitPoints = [];
            const orbitGeometry = new THREE.BufferGeometry();
            
            for (let i = 0; i <= 128; i++) {
                const angle = (i / 128) * Math.PI * 2;
                const x = 10 * Math.cos(angle);
                const z = 10 * Math.sin(angle);
                orbitPoints.push(x, 0, z);
            }
            
            orbitGeometry.setAttribute('position', new THREE.Float32BufferAttribute(orbitPoints, 3));
            const orbitMaterial = new THREE.LineBasicMaterial({ 
                color: 0x444488, 
                transparent: true,
                opacity: 0.3,
                linewidth: 1
            });
            const orbit = new THREE.Line(orbitGeometry, orbitMaterial);
            scene.add(orbit);
        }
        
        // Create other planets for solar system context
        function createOtherPlatnets() {
           // This function was empty in the provided code, keeping it as is.
        }
        
        // Create a realistic 3D gray polygon asteroid with irregular rocky appearance
        function createRealisticAsteroid() {
            const asteroidGeometry = new THREE.DodecahedronGeometry(0.3, 1);
            // Apply vertex displacement for irregular rocky appearance
            const positionAttribute = asteroidGeometry.getAttribute('position');
            const vertex = new THREE.Vector3();
            
            for (let i = 0; i < positionAttribute.count; i++) {
                vertex.fromBufferAttribute(positionAttribute, i);
                // Random displacement for rocky appearance
                vertex.x += (Math.random() - 0.5) * 0.1;
                vertex.y += (Math.random() - 0.5) * 0.1;
                vertex.z += (Math.random() - 0.5) * 0.1;
                positionAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
            }
            
            asteroidGeometry.computeVertexNormals();
            
            const asteroidMaterial = new THREE.MeshStandardMaterial({
                color: 0x808080,
                roughness: 0.8,
                metalness: 0.2
            });
            
            asteroid = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
            asteroid.castShadow = true;
            asteroid.receiveShadow = true;
            
            // Position asteroid in its orbit
            updateAsteroidPosition(0);
            scene.add(asteroid);
            
            // Add asteroid orbit visualization
            const orbitPoints = [];
            const orbitGeometry = new THREE.BufferGeometry();
            
            for (let i = 0; i <= 128; i++) {
                const angle = (i / 128) * Math.PI * 2;
                const point = calculateOrbitalPosition(angle);
                orbitPoints.push(point.x, point.y, point.z);
            }
            
            orbitGeometry.setAttribute('position', new THREE.Float32BufferAttribute(orbitPoints, 3));
            const orbitMaterial = new THREE.LineBasicMaterial({ 
                color: 0x8888ff, 
                transparent: true,
                opacity: 0.5,
                linewidth: 1
            });
            const orbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
            scene.add(orbitLine);
        }
        
        // Calculate orbital position based on true anomaly
        function calculateOrbitalPosition(trueAnomaly) {
            const semiMajorAxis = orbitalParams.semiMajorAxis * SCALE.ORBIT;
            const eccentricity = orbitalParams.eccentricity;
            const inclination = orbitalParams.inclination * Math.PI / 180;
            
            const distance = semiMajorAxis * (1 - eccentricity * eccentricity) / (1 + eccentricity * Math.cos(trueAnomaly));
            
            const x = distance * Math.cos(trueAnomaly);
            const y = distance * Math.sin(trueAnomaly) * Math.sin(inclination);
            const z = distance * Math.sin(trueAnomaly) * Math.cos(inclination);
            
            return new THREE.Vector3(x, y, z);
        }
        
        // Solve Kepler's equation for eccentric anomaly
        function solveKepler(M, e, precision = 1e-8) {
            let E = M;
            let delta = 1;
            
            while (Math.abs(delta) > precision) {
                delta = (E - e * Math.sin(E) - M) / (1 - e * Math.cos(E));
                E -= delta;
            }
            
            return E;
        }
        
        // Update asteroid position in orbit
        function updateAsteroidPosition(time) {
            // Calculate position in elliptical orbit
            const semiMajorAxis = orbitalParams.semiMajorAxis * SCALE.ORBIT;
            const eccentricity = orbitalParams.eccentricity;
            
            // Calculate true anomaly (angle in orbit)
            const meanAnomaly = (2 * Math.PI * time) / orbitalParams.period;
            const eccentricAnomaly = solveKepler(meanAnomaly, eccentricity);
            const trueAnomaly = 2 * Math.atan2(
                Math.sqrt(1 + eccentricity) * Math.sin(eccentricAnomaly / 2),
                Math.sqrt(1 - eccentricity) * Math.cos(eccentricAnomaly / 2)
            );
            
            // Update asteroid position
            const position = calculateOrbitalPosition(trueAnomaly);
            asteroid.position.copy(position);
        }
        
        // Simulate orbital motion
        function simulateOrbit() {
            if (orbitAnimationId) {
                cancelAnimationFrame(orbitAnimationId);
                orbitAnimationId = null;
            }
            
            currentMode = 'orbit';
            updateNotification("Simulating Impactor 2025 orbital path");
            
            let time = 0;
            const orbitalSpeed = 0.01; // Controls animation speed
            
            function animateOrbit() {
                time += orbitalSpeed;
                
                // Update asteroid position
                updateAsteroidPosition(time);
                
                // Make camera follow the asteroid
                const cameraDistance = 8;
                camera.position.set(
                    asteroid.position.x + cameraDistance,
                    asteroid.position.y + cameraDistance * 0.5,
                    asteroid.position.z + cameraDistance
                );
                camera.lookAt(asteroid.position);
                
                // Rotate asteroid for realism
                asteroid.rotation.y += 0.01;
                asteroid.rotation.x += 0.005;
                
                orbitAnimationId = requestAnimationFrame(animateOrbit);
            }
            
            animateOrbit();
        }
        
        // Simulate impact scenario with Earth
        function simulateImpact() {
            if (impactAnimationId) {
                cancelAnimationFrame(impactAnimationId);
                impactAnimationId = null;
            }
            
            if (orbitAnimationId) {
                cancelAnimationFrame(orbitAnimationId);
                orbitAnimationId = null;
            }
            
            currentMode = 'impact';
            updateNotification("Simulating impact scenario with Earth");
            document.getElementById('impactor-2025-section').querySelector('#impactVisualization').innerHTML = 
                "IMPACT IMMINENT! Simulating trajectory...<br>Estimated impact energy: 120 MT TNT";
            
            // Position asteroid for approach to Earth
            asteroid.position.set(20, 2, 5);
            
            let time = 0;
            const impactSpeed = 0.02;
            
            function animateImpact() {
                time += impactSpeed;
                
                // Calculate approach trajectory toward Earth
                const earthPosition = earth.position.clone();
                const direction = earthPosition.clone().sub(asteroid.position).normalize();
                const speed = 0.5;
                
                asteroid.position.add(direction.multiplyScalar(speed));
                
                // Rotate asteroid for dramatic effect
                asteroid.rotation.x += 0.05;
                asteroid.rotation.y += 0.03;
                asteroid.rotation.z += 0.02;
                
                // Update camera to follow approach
                camera.position.set(
                    asteroid.position.x + 5,
                    asteroid.position.y + 3,
                    asteroid.position.z + 5
                );
                camera.lookAt(asteroid.position);
                
                // Check for impact with Earth
                if (asteroid.position.distanceTo(earth.position) < (SCALE.EARTH + SCALE.ASTEROID) * 1.2) {
                    // Impact occurred
                    document.getElementById('impactor-2025-section').querySelector('#impactVisualization').innerHTML = 
                        "IMPACT! Energy release: 120 MT TNT<br>" +
                        "Crater: 3.2 km diameter, 450 m deep<br>" +
                        "Equivalent to magnitude 7.8 earthquake";
                    
                    // Create impact effect
                    createImpactEffect();
                    
                    // Stop animation
                    cancelAnimationFrame(impactAnimationId);
                    impactAnimationId = null;
                    return;
                }
                
                impactAnimationId = requestAnimationFrame(animateImpact);
            }
            
            animateImpact();
        }
        
        // Create visual effect for impact
        function createImpactEffect() {
            // Create explosion effect
            const explosionGeometry = new THREE.SphereGeometry(1, 16, 16);
            const explosionMaterial = new THREE.MeshBasicMaterial({
                color: 0xff5500,
                transparent: true,
                opacity: 0.8
            });
            
            const explosion = new THREE.Mesh(explosionGeometry, explosionMaterial);
            explosion.position.copy(earth.position);
            scene.add(explosion);
            
            // Animate explosion
            let explosionScale = 1;
            function animateExplosion() {
                explosionScale += 0.2;
                explosion.scale.set(explosionScale, explosionScale, explosionScale);
                explosionMaterial.opacity -= 0.02;
                
                if (explosionMaterial.opacity > 0) {
                    requestAnimationFrame(animateExplosion);
                } else {
                    scene.remove(explosion);
                }
            }
            
            animateExplosion();
        }
        
        // Reset view to default
        function resetView() {
            // Stop any ongoing animations
            stopAnimations();
            
            currentMode = 'default';
            updateNotification("Solar System View - Tracking Impactor 2025");
            document.getElementById('impactor-2025-section').querySelector('#impactVisualization').innerHTML = 
                "Solar System View - Earth shown to scale with asteroid";
            
            // Reset asteroid position
            updateAsteroidPosition(0);
            
            // Reset camera
            camera.position.set(0, 20, 30);
            camera.lookAt(0, 0, 0);
            controls.reset();
            
            // Update data display
            simulateDataUpdates();
        }
        
        // Update notification text
        function updateNotification(text) {
            const notification = document.getElementById('impactor-2025-section').querySelector('#notification');
            if (notification) {
                notification.textContent = text;
            }
        }
        
        // Animation loop
        function animate() {
            orbitAnimationId = requestAnimationFrame(animate); // Use orbitAnimationId for the main loop
            
            // Make Sun pulse slightly for solar flare effect
            if (sun) {
                sun.scale.x = 1 + Math.sin(Date.now() * 0.001) * 0.05;
                sun.scale.y = 1 + Math.sin(Date.now() * 0.001) * 0.05;
                sun.scale.z = 1 + Math.sin(Date.now() * 0.001) * 0.05;
            }
            
            // Rotate Earth
            if (earth) {
                earth.rotation.y += 0.002;
            }
            
            // Only rotate asteroid in default mode
            if (isRotating && currentMode === 'default' && asteroid) {
                asteroid.rotation.y += 0.005;
                asteroid.rotation.x += 0.002;
            }
            
            if (controls) {
                controls.update();
            }
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // Handle window resize
        function onWindowResize() {
            const canvas = document.getElementById('solarSystemCanvas');
            if (canvas && camera && renderer) {
                camera.aspect = canvas.clientWidth / canvas.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            }
        }
        
        // Simulate data updates
        function simulateDataUpdates() {
            // Ensure elements exist before updating
            const currentDistanceElem = document.getElementById('impactor-2025-section').querySelector('#currentDistance');
            const relativeVelocityElem = document.getElementById('impactor-2025-section').querySelector('#relativeVelocity');
            const impactProbabilityElem = document.getElementById('impactor-2025-section').querySelector('#impactProbability');

            if (currentDistanceElem && relativeVelocityElem && impactProbabilityElem && asteroid && earth) {
                // Update distance
                const distance = asteroid.position.distanceTo(earth.position) / SCALE.ORBIT;
                currentDistanceElem.textContent = distance.toFixed(3) + ' AU';
                
                // Update velocity (simulated)
                const velocity = 15.2 + (Math.random() - 0.5) * 0.1;
                relativeVelocityElem.textContent = velocity.toFixed(1) + ' km/s';
                
                // Update impact probability (simulated)
                const probability = 1 / (12500 + Math.floor(Math.random() * 1000));
                impactProbabilityElem.textContent = '1 in ' + Math.floor(1 / probability).toLocaleString();
            }
            
            // Schedule next update
            setTimeout(simulateDataUpdates, 3000);
        }

        return {
            init: init,
            stopAnimations: stopAnimations // Expose stopAnimations
        };
    })();


    // --- Asteroid Map (kkkk.html) Logic ---
    let asteroidMapInitialized = false;
    let asteroidMapAnimationId; // To store the requestAnimationFrame ID

    function initAsteroidMap() {
        // Clear previous Three.js objects and dispose resources if already initialized
        if (asteroidMapInitialized && window.asteroidMap && window.asteroidMap.scene) {
            window.asteroidMap.scene.children.forEach(child => {
                if (child.geometry) child.geometry.dispose();
                if (child.material) {
                    if (Array.isArray(child.material)) {
                        child.material.forEach(m => m.dispose());
                    } else {
                        child.material.dispose();
                    }
                }
                window.asteroidMap.scene.remove(child);
            });
            if (window.asteroidMap.renderer) window.asteroidMap.renderer.dispose();
            if (window.asteroidMap.controls) window.asteroidMap.controls.dispose();
            if (window.asteroidMap.labelRenderer) {
                // Remove the DOM element for labelRenderer
                const labelRendererDom = window.asteroidMap.labelRenderer.domElement;
                if (labelRendererDom && labelRendererDom.parentNode) {
                    labelRendererDom.parentNode.removeChild(labelRendererDom);
                }
            }
            // Reset the flag and animation ID
            asteroidMapInitialized = false;
            if (typeof asteroidMapAnimationId !== 'undefined') {
                cancelAnimationFrame(asteroidMapAnimationId);
                asteroidMapAnimationId = undefined;
            }
        }

        const asteroidMap = {}; // Encapsulate all kkkk.html logic in this object
        window.asteroidMap = asteroidMap; // Make it globally accessible for cleanup

        // NASA API key
        asteroidMap.API_KEY = "AnV0vXLWI76ajKaWyOwkBPT6Uohq31rbMD7yZaNG"; // Replace with your actual API key if needed
        asteroidMap.API_BASE_URL = "https://api.nasa.gov/neo/rest/v1/feed";

        // Demo data fallback (simplified for brevity, but includes necessary orbital data)
        asteroidMap.DEMO_DATA = {
            near_earth_objects: {
            "2023-09-20": [
                {
                id: "2000433",
                name: "433 Eros (A898 PA)",
                nasa_jpl_url: "https://ssd.jpl.nasa.gov/tools/sbdb_lookup.html#/?sstr=2000433",
                absolute_magnitude_h: 10.31,
                estimated_diameter: {
                    kilometers: { estimated_diameter_min: 16.84, estimated_diameter_max: 37.66 }
                },
                is_potentially_hazardous_asteroid: false,
                close_approach_data: [{
                    close_approach_date: "2023-09-20",
                    relative_velocity: { kilometers_per_second: "5.58" },
                    orbiting_body: "Earth"
                }],
                orbital_data: {
                    eccentricity: "0.2226873284167586",
                    semi_major_axis: "1.458070832985963", // AU
                    inclination: "10.82906984553425" // Degrees
                }
                },
                {
                id: "2001862",
                name: "1862 Apollo (1932 HA)",
                nasa_jpl_url: "https://ssd.jpl.nasa.gov/tools/sbdb_lookup.html#/?sstr=2001862",
                absolute_magnitude_h: 16.25,
                estimated_diameter: {
                    kilometers: { estimated_diameter_min: 1.32, estimated_diameter_max: 2.95 }
                },
                is_potentially_hazardous_asteroid: true,
                close_approach_data: [{
                    close_approach_date: "2023-09-20",
                    relative_velocity: { kilometers_per_second: "9.34" },
                    orbiting_body: "Earth"
                }],
                orbital_data: {
                    eccentricity: "0.5599455664892574",
                    semi_major_axis: "1.471396210378433",
                    inclination: "6.353042609533057"
                }
                },
                {
                id: "2001915",
                name: "1915 Quetzalcoatl (1953 EA)",
                nasa_jpl_url: "https://ssd.jpl.nasa.gov/tools/sbdb_lookup.html#/?sstr=2001915",
                absolute_magnitude_h: 19.03,
                estimated_diameter: {
                    kilometers: { estimated_diameter_min: 0.38, estimated_diameter_max: 0.85 }
                },
                is_potentially_hazardous_asteroid: false,
                close_approach_data: [{
                    close_approach_date: "2023-09-20",
                    relative_velocity: { kilometers_per_second: "13.45" },
                    orbiting_body: "Earth"
                }],
                orbital_data: {
                    eccentricity: "0.5705372774060255",
                    semi_major_axis: "1.242247559143814",
                    inclination: "20.40514441141258"
                }
                },
                {
                id: "2000001",
                name: "1 Ceres",
                nasa_jpl_url: "https://ssd.jpl.nasa.gov/tools/sbdb_lookup.html#/?sstr=2000001",
                absolute_magnitude_h: 3.34,
                estimated_diameter: {
                    kilometers: { estimated_diameter_min: 939.4, estimated_diameter_max: 939.4 }
                },
                is_potentially_hazardous_asteroid: false,
                close_approach_data: [{
                    close_approach_date: "2023-09-20",
                    relative_velocity: { kilometers_per_second: "17.89" },
                    orbiting_body: "Sun"
                }],
                orbital_data: {
                    eccentricity: "0.0785",
                    semi_major_axis: "2.767",
                    inclination: "10.59"
                }
                }
            ]
            }
        };

        // UI elements
        asteroidMap.dateInput = document.getElementById("asteroid-map-date-select");
        asteroidMap.timespanSelect = document.getElementById("asteroid-map-timespan");
        asteroidMap.fetchBtn = document.getElementById("asteroid-map-fetch-data");
        asteroidMap.infoPanel = document.getElementById("asteroid-map-info-panel");
        asteroidMap.closeInfoBtn = document.getElementById("asteroid-map-close-info");
        asteroidMap.loadingDiv = document.getElementById("asteroid-map-loading");
        asteroidMap.errorDiv = document.getElementById("asteroid-map-error-message");
        asteroidMap.dismissErrorBtn = document.getElementById("asteroid-map-dismiss-error");
        asteroidMap.zoomInBtn = document.getElementById("asteroid-map-zoom-in");
        asteroidMap.zoomOutBtn = document.getElementById("asteroid-map-zoom-out");
        asteroidMap.guideButton = document.getElementById("asteroid-map-guide-button");
        asteroidMap.guideModalOverlay = document.getElementById("asteroid-map-guide-modal-overlay");
        asteroidMap.guideModalCloseBtn = asteroidMap.guideModalOverlay.querySelector(".close-modal");
        asteroidMap.speedSlider = document.getElementById("asteroid-map-speed-slider");
        asteroidMap.speedValue = document.getElementById("asteroid-map-speed-value");
        asteroidMap.animationToggle = document.getElementById("asteroid-map-animation-toggle");
        asteroidMap.toggleLabelsSwitch = document.getElementById("asteroid-map-toggle-labels"); // New label toggle switch

        // Animation state
        asteroidMap.animationSpeed = 0.5; // Updated default speed
        asteroidMap.animationActive = true;
        asteroidMap.isGuideModalOpen = false; // Track guide modal state
        asteroidMap.isInfoPanelOpen = false; // Track info panel state
        asteroidMap.isLoadingVisible = false; // Track loading popup state

        // Three.js setup
        asteroidMap.sceneContainer = document.getElementById("asteroid-map-scene-container"); // Changed ID
        asteroidMap.scene = new THREE.Scene();

        // Dark space background (will be overridden by starfield)
        asteroidMap.scene.background = new THREE.Color(0x000010);

        asteroidMap.camera = new THREE.PerspectiveCamera(60, asteroidMap.sceneContainer.clientWidth / asteroidMap.sceneContainer.clientHeight, 0.1, 1000);
        asteroidMap.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        asteroidMap.renderer.setSize(asteroidMap.sceneContainer.clientWidth, asteroidMap.sceneContainer.clientHeight);
        asteroidMap.renderer.setPixelRatio(window.devicePixelRatio);
        asteroidMap.sceneContainer.appendChild(asteroidMap.renderer.domElement);

        // CSS2DRenderer for labels
        asteroidMap.labelRenderer = new THREE.CSS2DRenderer();
        asteroidMap.labelRenderer.setSize(asteroidMap.sceneContainer.clientWidth, asteroidMap.sceneContainer.clientHeight);
        asteroidMap.labelRenderer.domElement.style.position = 'absolute';
        asteroidMap.labelRenderer.domElement.style.top = '0px';
        asteroidMap.labelRenderer.domElement.style.pointerEvents = 'none'; // Allow clicks to pass through
        // Set a lower z-index for the label renderer's DOM element
        asteroidMap.labelRenderer.domElement.style.zIndex = '0'; 
        asteroidMap.sceneContainer.appendChild(asteroidMap.labelRenderer.domElement);

        // Controls - Enable full panning
        asteroidMap.controls = new THREE.OrbitControls(asteroidMap.camera, asteroidMap.renderer.domElement);
        asteroidMap.controls.enableDamping = true;
        asteroidMap.controls.dampingFactor = 0.05;
        asteroidMap.controls.minDistance = 5;
        asteroidMap.controls.maxDistance = 150;
        asteroidMap.controls.enablePan = true; // Enable panning
        asteroidMap.controls.rotateSpeed = 0.5; // Adjust rotation speed
        asteroidMap.controls.panSpeed = 1.0;    // Increased pan speed for better movement

        // Initial camera position for a good overview
        asteroidMap.camera.position.set(0, 25, 40);
        asteroidMap.controls.update();

        // Solar system group (all celestial bodies and orbits will be children of this)
        asteroidMap.solarSystem = new THREE.Group();
        asteroidMap.scene.add(asteroidMap.solarSystem);

        // Sun
        asteroidMap.sunGeometry = new THREE.SphereGeometry(2, 32, 32); // Geometry from f-map.html
        asteroidMap.sunMaterial = new THREE.MeshStandardMaterial({
            color: 0xffaa00, // Base yellow/orange color from f-map.html
            emissive: 0xff8800, // Emissive color for glow from f-map.html
            emissiveIntensity: 1.5, // Stronger glow from f-map.html
        });
        asteroidMap.sun = new THREE.Mesh(asteroidMap.sunGeometry, asteroidMap.sunMaterial);
        asteroidMap.solarSystem.add(asteroidMap.sun);

        // Sun Label
        asteroidMap.sunLabelDiv = document.createElement('div');
        asteroidMap.sunLabelDiv.className = 'label';
        asteroidMap.sunLabelDiv.textContent = 'Sun';
        asteroidMap.sunLabel = new THREE.CSS2DObject(asteroidMap.sunLabelDiv);
        asteroidMap.sunLabel.position.set(0, -2.5, 0); // Position below the sun
        asteroidMap.sun.add(asteroidMap.sunLabel);

        // Earth orbit ring for reference
        asteroidMap.earthOrbitRadius = 10; // Astronomical Units (AU) scale
        asteroidMap.earthOrbitGeometry = new THREE.RingGeometry(asteroidMap.earthOrbitRadius - 0.05, asteroidMap.earthOrbitRadius + 0.05, 64);
        asteroidMap.earthOrbitMaterial = new THREE.MeshBasicMaterial({ color: 0x0066ff, side: THREE.DoubleSide, transparent: true, opacity: 0.3 });
        asteroidMap.earthOrbit = new THREE.Mesh(asteroidMap.earthOrbitGeometry, asteroidMap.earthOrbitMaterial);
        asteroidMap.earthOrbit.rotation.x = Math.PI / 2; // Align with the ecliptic plane
        asteroidMap.solarSystem.add(asteroidMap.earthOrbit);

        // Earth sphere
        asteroidMap.earthGeometry = new THREE.SphereGeometry(0.5, 32, 32);
        asteroidMap.earthMaterial = new THREE.MeshStandardMaterial({ color: 0x2233ff });
        asteroidMap.earth = new THREE.Mesh(asteroidMap.earthGeometry, asteroidMap.earthMaterial);
        asteroidMap.earth.position.x = asteroidMap.earthOrbitRadius; // Initial position Earth on its orbit
        asteroidMap.solarSystem.add(asteroidMap.earth);

        // Earth Label
        asteroidMap.earthLabelDiv = document.createElement('div');
        asteroidMap.earthLabelDiv.className = 'label';
        asteroidMap.earthLabelDiv.textContent = 'Earth';
        asteroidMap.earthLabel = new THREE.CSS2DObject(asteroidMap.earthLabelDiv);
        asteroidMap.earthLabel.position.set(0, -0.8, 0); // Position below the earth
        asteroidMap.earth.add(asteroidMap.earthLabel);

        // Earth orbital parameters for animation
        asteroidMap.earth.userData.orbitalParams = {
            semiMajorAxis: asteroidMap.earthOrbitRadius,
            eccentricity: 0, // Assuming circular orbit for simplicity
            inclination: 0, // Earth's orbit is the reference plane
            orbitalPeriod: 365, // Roughly 365 units for a year (scaled for visualization)
            initialAngle: Math.random() * Math.PI * 2,
            elapsedTime: Math.random() * 365
        };

        // Lights
        asteroidMap.ambientLight = new THREE.AmbientLight(0x333333);
        asteroidMap.scene.add(asteroidMap.ambientLight);
        asteroidMap.directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        asteroidMap.directionalLight.position.set(5, 5, 5);
        asteroidMap.scene.add(asteroidMap.directionalLight);

        // Asteroids and labels storage
        asteroidMap.asteroidObjects = []; // Stores Three.js Mesh objects for raycasting
        asteroidMap.asteroidLabels = [];  // Stores CSS22DObject for labels

        // Starfield background
        asteroidMap.starCount = 10000; // Star count from f-map.html
        asteroidMap.starGeometry = new THREE.BufferGeometry();
        asteroidMap.starPositions = new Float32Array(asteroidMap.starCount * 3);
        asteroidMap.starColors = new Float32Array(asteroidMap.starCount * 3);

        for (let i = 0; i < asteroidMap.starCount; i++) {
            const r = 500 + Math.random() * 500; // Increased distance range for stars
            const theta = Math.random() * 2 * Math.PI;
            const phi = Math.acos(2 * Math.random() - 1); // Distribute points evenly on a sphere

            asteroidMap.starPositions[i * 3] = r * Math.sin(phi) * Math.cos(theta);
            asteroidMap.starPositions[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
            asteroidMap.starPositions[i * 3 + 2] = r * Math.cos(phi);

            // Random color for stars
            const color = new THREE.Color();
            color.setHSL(Math.random(), 0.7, 0.8); // Hue, Saturation, Lightness
            asteroidMap.starColors[i * 3] = color.r;
            asteroidMap.starColors[i * 3 + 1] = color.g;
            asteroidMap.starColors[i * 3 + 2] = color.b;
        }

        asteroidMap.starGeometry.setAttribute('position', new THREE.BufferAttribute(asteroidMap.starPositions, 3));
        asteroidMap.starGeometry.setAttribute('color', new THREE.BufferAttribute(asteroidMap.starColors, 3));
        asteroidMap.starMaterial = new THREE.PointsMaterial({
            size: 0.1, // Slightly smaller stars for denser look
            vertexColors: true, // Enable vertex colors
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            sizeAttenuation: true
        });
        asteroidMap.starField = new THREE.Points(asteroidMap.starGeometry, asteroidMap.starMaterial);
        asteroidMap.scene.add(asteroidMap.starField);

        // Helper to create label DOM elements
        asteroidMap.createLabel = function(text, yOffset = -0.8) {
            const div = document.createElement('div');
            div.className = 'label';
            div.textContent = text;
            const label = new THREE.CSS2DObject(div);
            label.position.set(0, yOffset, 0);
            return label;
        }

        // Function to create an asteroid mesh, its orbit line, and its label
        asteroidMap.createAsteroid = function(asteroidData) {
            // Scale asteroid size for better visibility, clamping between min/max
            const size = Math.max(0.05, Math.min(0.5, asteroidData.estimated_diameter.kilometers.estimated_diameter_min / 10));

            const geometry = new THREE.SphereGeometry(8, 6); // Reduced segments for performance
            const material = new THREE.MeshStandardMaterial({
                color: asteroidData.is_potentially_hazardous_asteroid ? 0xff4444 : 0xaaaaaa // Red for hazardous
            });
            const asteroid = new THREE.Mesh(geometry, material);
            asteroid.scale.set(size, size, size); // Apply size via scale

            // Orbital data parsing with fallbacks
            let semiMajorAxis = 15; // Default AU if data is missing
            let eccentricity = 0;
            let inclination = 0; // in radians
            let orbitalPeriod = 100; // Arbitrary period for animation speed

            if (asteroidData.orbital_data) {
                semiMajorAxis = parseFloat(asteroidData.orbital_data.semi_major_axis) || semiMajorAxis;
                eccentricity = parseFloat(asteroidData.orbital_data.eccentricity) || eccentricity;
                inclination = parseFloat(asteroidData.orbital_data.inclination) * Math.PI / 180 || inclination;
                // Estimate orbital period based on Kepler's Third Law (P^2 ~ a^3)
                // For Earth, a=1 AU, P=1 year. So P_asteroid = sqrt(a_asteroid^3) * P_earth
                // We'll use a scaled period for visualization, not real-world years
                orbitalPeriod = Math.sqrt(Math.pow(semiMajorAxis, 3)) * 50; // Scale factor 50 for animation speed
            }

            // Create orbit line (ellipse)
            const orbitPoints = [];
            const steps = 128; // More steps for smoother ellipse
            for (let i = 0; i <= steps; i++) {
                const theta = (i / steps) * 2 * Math.PI;
                // Formula for distance in an elliptical orbit
                const r = (semiMajorAxis * (1 - eccentricity * eccentricity)) / (1 + eccentricity * Math.cos(theta));
                const x = r * Math.cos(theta);
                const z = r * Math.sin(theta);
                orbitPoints.push(new THREE.Vector3(x, 0, z));
            }

            const orbitGeometry = new THREE.BufferGeometry().setFromPoints(orbitPoints);
            const orbitMaterial = new THREE.LineBasicMaterial({
                color: asteroidData.is_potentially_hazardous_asteroid ? 0xff6666 : 0x888888,
                transparent: true,
                opacity: 0.3,
                linewidth: 1
            });
            const orbit = new THREE.Line(orbitGeometry, orbitMaterial);
            orbit.rotation.x = inclination; // Apply inclination
            asteroidMap.solarSystem.add(orbit);

            // Store orbital parameters for animation
            asteroid.userData.orbitalParams = {
                semiMajorAxis,
                eccentricity,
                inclination,
                orbitalPeriod,
                initialAngle: Math.random() * Math.PI * 2, // Random starting position on orbit
                elapsedTime: Math.random() * orbitalPeriod // Random start time for animation
            };

            // Initial position of the asteroid on its orbit
            const initialAngle = asteroid.userData.orbitalParams.initialAngle;
            const r_initial = (semiMajorAxis * (1 - eccentricity * eccentricity)) / (1 + eccentricity * Math.cos(initialAngle));
            const x_initial = r_initial * Math.cos(initialAngle);
            const z_initial = r_initial * Math.sin(initialAngle);
            asteroid.position.set(x_initial, 0, z_initial);
            asteroid.position.applyAxisAngle(new THREE.Vector3(1, 0, 0), inclination); // Apply inclination to position

            // Store asteroid data for info panel
            asteroid.userData.type = 'asteroid';
            asteroid.userData.data = asteroidData;
            asteroid.userData.orbit = orbit; // Keep reference to its orbit line

            asteroidMap.solarSystem.add(asteroid);
            asteroidMap.asteroidObjects.push(asteroid);

            // Create and store label
            const label = asteroidMap.createLabel(asteroidData.name || asteroidData.id, -size - 0.5); // Position label below asteroid
            asteroid.add(label); // Add label as child of asteroid mesh
            asteroidMap.asteroidLabels.push(label);

            return asteroid;
        }

        // Function to update asteroid positions along their orbits
        asteroidMap.clock = new THREE.Clock();
        asteroidMap.updateAsteroidPositions = function() {
            const delta = asteroidMap.clock.getDelta(); // Time elapsed since last frame

            // Update Earth's position
            if (asteroidMap.animationActive) {
                const earthOrbitalParams = asteroidMap.earth.userData.orbitalParams;
                earthOrbitalParams.elapsedTime += delta * asteroidMap.animationSpeed * 10; // Earth moves faster for visualization
                
                // Calculate mean anomaly
                const M_earth = (2 * Math.PI * earthOrbitalParams.elapsedTime / earthOrbitalParams.orbitalPeriod) % (2 * Math.PI);
                
                // For circular orbit, true anomaly is equal to mean anomaly
                const trueAnomaly_earth = M_earth;

                // Calculate position in orbital plane
                const r_earth = earthOrbitalParams.semiMajorAxis * (1 - earthOrbitalParams.eccentricity * earthOrbitalParams.eccentricity) / (1 + earthOrbitalParams.eccentricity * Math.cos(trueAnomaly_earth));
                const x_earth = r_earth * Math.cos(trueAnomaly_earth);
                const z_earth = r_earth * Math.sin(trueAnomaly_earth);
                
                asteroidMap.earth.position.set(x_earth, 0, z_earth);
                // Apply inclination (though 0 for Earth in this setup)
                asteroidMap.earth.position.applyAxisAngle(new THREE.Vector3(1, 0, 0), earthOrbitalParams.inclination);
            }

            asteroidMap.asteroidObjects.forEach(asteroid => {
                if (!asteroidMap.animationActive) return; // Skip if animation is paused
                
                const { semiMajorAxis, eccentricity, inclination, orbitalPeriod } = asteroid.userData.orbitalParams;

                asteroid.userData.orbitalParams.elapsedTime += delta * asteroidMap.animationSpeed * 10; // Scale speed by new slider range
                
                // --- Kepler's Equation Solver ---
                // Kepler's Equation: M = E - e * sin(E)
                // Where:
                // M = Mean Anomaly (angle that increases uniformly with time)
                // E = Eccentric Anomaly (angle from the center of the ellipse to the body, projected onto the circumscribing circle)
                // e = Eccentricity (a measure of how elliptical the orbit is)

                // 1. Calculate Mean Anomaly (M)
                // M represents the average angular speed multiplied by time.
                // It's the angle a fictitious body would have if it moved in a circular orbit with the same period.
                const M = (2 * Math.PI * asteroid.userData.orbitalParams.elapsedTime / orbitalPeriod) % (2 * Math.PI);

                // 2. Solve Kepler's Equation for Eccentric Anomaly (E)
                // This equation is transcendental and cannot be solved analytically for E.
                // We use an iterative approximation (Newton-Raphson method is common) to find E.
                let E = M; // Initial guess for E is M
                let deltaE = 1; // Initialize deltaE to a value greater than epsilon to enter the loop
                const epsilon = 0.0001; // Tolerance for the approximation. Smaller epsilon means more accuracy, but more iterations.

                // Iterate until E converges to a satisfactory precision
                while (Math.abs(deltaE) > epsilon) { // Corrected variable name from ddeltaE to deltaE
                    // The function to find the root of is f(E) = E - e * sin(E) - M
                    // The derivative f'(E) = 1 - e * cos(E)
                    // Newton-Raphson iteration: E_new = E_old - f(E_old) / f'(E_old)
                    deltaE = (E - eccentricity * Math.sin(E) - M) / (1 - eccentricity * Math.cos(E));
                    E -= deltaE;
                }

                // 3. Calculate True Anomaly (nu or f) from Eccentric Anomaly (E)
                // True Anomaly is the actual angle of the body from the periapsis (closest point to the Sun).
                // This formula converts Eccentric Anomaly to True Anomaly.
                const trueAnomaly = 2 * Math.atan2(
                    Math.sqrt(1 + eccentricity) * Math.sin(E / 2),
                    Math.sqrt(1 - eccentricity) * Math.cos(E / 2)
                );

                // 4. Calculate distance from Sun (r)
                // This is the polar equation of an ellipse, giving the distance from the focus (Sun) to the body.
                const r = semiMajorAxis * (1 - eccentricity * Math.cos(E));

                // 5. Calculate 2D position in orbital plane
                // Assuming the periapsis is along the positive X-axis in the orbital plane.
                const x_orbital = r * Math.cos(trueAnomaly);
                const y_orbital = r * Math.sin(trueAnomaly); // Using y for the orbital plane for now

                // Create a vector for the position in the orbital plane
                const positionInPlane = new THREE.Vector3(x_orbital, 0, y_orbital);

                // 6. Rotate the position by the inclination around the X-axis
                // This tilts the orbital plane relative to the ecliptic (XY) plane.
                const inclinedPosition = positionInPlane.applyAxisAngle(new THREE.Vector3(1, 0, 0), inclination);

                asteroid.position.copy(inclinedPosition);
            });
        }

        // Debounce function to limit how often a function is called
        asteroidMap.debounce = function(func, delay) {
            let timeout;
            return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // Function to update label visibility based on occlusion and UI state
        asteroidMap._updateLabelVisibility = function() {
            const showLabels = asteroidMap.toggleLabelsSwitch.checked;

            // Simple logic: if switch is off, hide all labels
            if (!showLabels) {
                asteroidMap.sunLabel.visible = false;
                asteroidMap.earthLabel.visible = false;
                asteroidMap.asteroidLabels.forEach(label => label.visible = false);
                return;
            }

            // If switch is on and no popups are open, show all labels
            if (!asteroidMap.isGuideModalOpen && !asteroidMap.isInfoPanelOpen && !asteroidMap.isLoadingVisible) {
                asteroidMap.sunLabel.visible = true;
                asteroidMap.earthLabel.visible = true;
                asteroidMap.asteroidLabels.forEach(label => label.visible = true);
                return;
            }

            // If switch is on but popups are open, hide all labels
            asteroidMap.sunLabel.visible = false;
            asteroidMap.earthLabel.visible = false;
            asteroidMap.asteroidLabels.forEach(label => label.visible = false);
        }

        // Debounced version of updateLabelVisibility
        asteroidMap.updateLabelVisibility = asteroidMap.debounce(asteroidMap._updateLabelVisibility, 100); // Debounce by 100ms

        // Function to display asteroid information in the panel
        asteroidMap.showAsteroidInfo = function(asteroidData) {
            const closeApproach = asteroidData.close_approach_data && asteroidData.close_approach_data[0];

            document.getElementById('asteroid-map-info-name').textContent = asteroidData.name || 'N/A';
            document.getElementById('asteroid-map-info-designation').textContent = asteroidData.id || 'N/A';

            const diameterMin = asteroidData.estimated_diameter?.kilometers?.estimated_diameter_min?.toFixed(2) || 'N/A';
            const diameterMax = asteroidData.estimated_diameter?.kilometers?.estimated_diameter_max?.toFixed(2) || 'N/A';
            document.getElementById('asteroid-map-info-diameter').textContent = `${diameterMin} - ${diameterMax} km`;

            document.getElementById('asteroid-map-info-approach').textContent = closeApproach?.close_approach_date || 'N/A';
            document.getElementById('asteroid-map-info-velocity').textContent = `${parseFloat(closeApproach?.relative_velocity?.kilometers_per_second || 0).toFixed(2)} km/s`;
            document.getElementById('asteroid-map-info-body').textContent = closeApproach?.orbiting_body || 'N/A';

            const nasaLink = document.getElementById('asteroid-map-info-link');
            if (asteroidData.nasa_jpl_url) {
                nasaLink.href = asteroidData.nasa_jpl_url;
                nasaLink.textContent = 'View on NASA JPL';
                nasaLink.style.display = 'inline';
            } else {
                nasaLink.style.display = 'none';
            }

            asteroidMap.infoPanel.style.display = 'block';
            asteroidMap.isInfoPanelOpen = true; // Set info panel state
            asteroidMap.updateLabelVisibility(); // Update label visibility
        }

        // Function to fetch asteroid data from NASA API
        asteroidMap.fetchAsteroidData = async function(startDate, days) {
            asteroidMap.showLoading(true);
            asteroidMap.errorDiv.style.display = 'none'; // Hide error message on new fetch

            try {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + parseInt(days));
                const endDateStr = endDate.toISOString().split('T')[0];

                const url = `${asteroidMap.API_BASE_URL}?start_date=${startDate}&end_date=${endDateStr}&api_key=${asteroidMap.API_KEY}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching asteroid data:', error);
                asteroidMap.showError();
                return asteroidMap.DEMO_DATA; // Fallback to demo data
            } finally {
                asteroidMap.showLoading(false);
            }
        }

        // Function to process and display asteroid data
        asteroidMap.displayAsteroidData = function(data) {
            // Clear existing asteroids, orbits, and labels
            asteroidMap.asteroidObjects.forEach(obj => {
                asteroidMap.solarSystem.remove(obj);
                if (obj.userData.orbit) {
                    asteroidMap.solarSystem.remove(obj.userData.orbit);
                }
            });
            asteroidMap.asteroidObjects.length = 0;
            asteroidMap.asteroidLabels.length = 0;

            // Process and display new asteroid data
            let asteroidCount = 0;
            for (const date in data.near_earth_objects) {
                data.near_earth_objects[date].forEach(asteroid => {
                    asteroidMap.createAsteroid(asteroid);
                    asteroidCount++;
                });
            }
            console.log(`Displayed ${asteroidCount} asteroids`);
            asteroidMap.updateLabelVisibility(); // Update labels after new asteroids are added
        }

        // Function to show/hide loading indicator
        asteroidMap.showLoading = function(show) {
            asteroidMap.loadingDiv.style.display = show ? 'block' : 'none';
            asteroidMap.isLoadingVisible = show; // Update loading popup state
            asteroidMap.updateLabelVisibility(); // Update label visibility
        }

        // Function to show error message
        asteroidMap.showError = function() {
            asteroidMap.errorDiv.style.display = 'block';
        }

        // Event Listeners
        // Set default date to 7 days ago (NASA API max feed range)
        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(today.getDate() - 7);
        const formattedDate = sevenDaysAgo.toISOString().split("T")[0];
        asteroidMap.dateInput.value = formattedDate;

        // Initial data load
        asteroidMap.fetchAsteroidData(formattedDate, asteroidMap.timespanSelect.value)
            .then(data => {
                asteroidMap.displayAsteroidData(data);
            });

        asteroidMap.fetchBtn.addEventListener('click', function () {
            const date = asteroidMap.dateInput.value;
            const days = asteroidMap.timespanSelect.value;
            asteroidMap.fetchAsteroidData(date, days)
            .then(data => {
                asteroidMap.displayAsteroidData(data);
            });
        });

        asteroidMap.closeInfoBtn.addEventListener('click', function () {
            asteroidMap.infoPanel.style.display = 'none';
            asteroidMap.isInfoPanelOpen = false; // Set info panel state
            asteroidMap.updateLabelVisibility(); // Update label visibility
        });

        asteroidMap.dismissErrorBtn.addEventListener('click', function () {
            asteroidMap.errorDiv.style.display = 'none';
        });

        // Raycaster for object interaction
        asteroidMap.raycaster = new THREE.Raycaster();
        asteroidMap.mouse = new THREE.Vector2();

        asteroidMap.onMouseClick = function(event) {
            // Don't process clicks if guide modal or loading is open
            if (asteroidMap.isGuideModalOpen || asteroidMap.isLoadingVisible) return;
            
            // Calculate mouse position in normalized device coordinates
            const rect = asteroidMap.renderer.domElement.getBoundingClientRect();
            asteroidMap.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            asteroidMap.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            // Update the raycaster
            asteroidMap.raycaster.setFromCamera(asteroidMap.mouse, asteroidMap.camera);

            // Calculate objects intersecting the picking ray
            const intersects = asteroidMap.raycaster.intersectObjects(asteroidMap.asteroidObjects);

            if (intersects.length > 0) {
                const asteroid = intersects[0].object;
                asteroidMap.showAsteroidInfo(asteroid.userData.data);
            } else {
                asteroidMap.infoPanel.style.display = 'none'; // Hide info panel if no asteroid clicked
                asteroidMap.isInfoPanelOpen = false; // Set info panel state
                asteroidMap.updateLabelVisibility(); // Update label visibility
            }
        }
        asteroidMap.sceneContainer.addEventListener('click', asteroidMap.onMouseClick, false);

        // UI Buttons for Zoom and Guide
        asteroidMap.targetFov = asteroidMap.camera.fov;
        asteroidMap.minFov = 15;
        asteroidMap.maxFov = 90;
        asteroidMap.zoomStep = 5;

        asteroidMap.zoomInBtn.addEventListener('click', () => {
            // Directly manipulate controls.object.fov for immediate effect
            // and then update targetFov to keep it in sync for smooth interpolation
            asteroidMap.controls.object.fov = Math.max(asteroidMap.minFov, asteroidMap.controls.object.fov - asteroidMap.zoomStep);
            asteroidMap.controls.object.updateProjectionMatrix();
            asteroidMap.targetFov = asteroidMap.controls.object.fov; // Keep targetFov in sync
        });
        asteroidMap.zoomOutBtn.addEventListener('click', () => {
            // Directly manipulate controls.object.fov for immediate effect
            // and then update targetFov to keep it in sync for smooth interpolation
            asteroidMap.controls.object.fov = Math.min(asteroidMap.maxFov, asteroidMap.controls.object.fov + asteroidMap.zoomStep);
            asteroidMap.controls.object.updateProjectionMatrix();
            asteroidMap.targetFov = asteroidMap.controls.object.fov; // Keep targetFov in sync
        });

        asteroidMap.guideButton.addEventListener('click', () => {
            asteroidMap.isGuideModalOpen = true;
            asteroidMap.guideModalOverlay.style.display = 'flex';
            asteroidMap.infoPanel.style.display = 'none'; // Hide info panel when guide is open
            asteroidMap.isInfoPanelOpen = false; // Ensure info panel state is false
            
            asteroidMap.updateLabelVisibility(); // Update label visibility based on guide modal state
        });
        
        asteroidMap.guideModalCloseBtn.addEventListener('click', () => {
            asteroidMap.isGuideModalOpen = false;
            asteroidMap.guideModalOverlay.style.display = 'none';
            
            asteroidMap.updateLabelVisibility(); // Update label visibility based on guide modal state
        });
        
        asteroidMap.guideModalOverlay.addEventListener('click', (e) => {
            if (e.target === asteroidMap.guideModalOverlay) {
                asteroidMap.isGuideModalOpen = false;
                asteroidMap.guideModalOverlay.style.display = 'none';
                
                asteroidMap.updateLabelVisibility(); // Update label visibility based on guide modal state
            }
        });

        // Speed slider control
        asteroidMap.updateSpeedDisplay = function() {
            if (asteroidMap.animationSpeed === 0) {
                asteroidMap.speedValue.textContent = 'Static';
            } else if (asteroidMap.animationSpeed < 0.2) {
                asteroidMap.speedValue.textContent = 'Slow';
            } else if (asteroidMap.animationSpeed < 1.0) {
                asteroidMap.speedValue.textContent = 'Normal';
            } else {
                asteroidMap.speedValue.textContent = 'Fast';
            }
        }
        
        asteroidMap.speedSlider.addEventListener('input', (e) => {
            asteroidMap.animationSpeed = parseFloat(e.target.value);
            asteroidMap.updateSpeedDisplay();
        });
        
        // Initialize speed display
        asteroidMap.updateSpeedDisplay();

        asteroidMap.animationToggle.addEventListener('click', () => {
            asteroidMap.animationActive = !asteroidMap.animationActive;
            asteroidMap.animationToggle.textContent = asteroidMap.animationActive ? 'Pause Orbits' : 'Resume Orbits';
            asteroidMap.animationToggle.classList.toggle('active', !asteroidMap.animationActive);
        });

        // New event listener for the label toggle switch
        asteroidMap.toggleLabelsSwitch.addEventListener('change', () => {
            asteroidMap.updateLabelVisibility(); // Trigger label visibility update when switch changes
        });

        // Handle window resize
        asteroidMap.onWindowResize = function() {
            const canvas = document.getElementById('asteroid-map-scene-container');
            if (canvas && asteroidMap.camera && asteroidMap.renderer && asteroidMap.labelRenderer) {
                asteroidMap.camera.aspect = canvas.clientWidth / canvas.clientHeight;
                asteroidMap.camera.updateProjectionMatrix();
                asteroidMap.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                asteroidMap.labelRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
                asteroidMap.updateLabelVisibility(); // Update label visibility on resize
            }
        }
        window.addEventListener('resize', asteroidMap.onWindowResize);

        // Animation loop
        asteroidMap.animate = function() {
            asteroidMapAnimationId = requestAnimationFrame(asteroidMap.animate);

            // Smoothly interpolate camera FOV towards targetFov
            if (Math.abs(asteroidMap.camera.fov - asteroidMap.targetFov) > 0.1) {
                asteroidMap.camera.fov += (asteroidMap.targetFov - asteroidMap.camera.fov) * 0.1;
                asteroidMap.camera.updateProjectionMatrix();
            }

            asteroidMap.updateAsteroidPositions(); // Animate asteroids along their orbits
            // The _updateLabelVisibility function is now called directly in the animation loop
            // to ensure labels are updated every frame, which is necessary for proper occlusion handling.
            asteroidMap._updateLabelVisibility();   // Update label visibility every frame to handle Sun occlusion

            asteroidMap.controls.update(); // Only required if controls.enableDamping is set to true
            asteroidMap.renderer.render(asteroidMap.scene, asteroidMap.camera);
            asteroidMap.labelRenderer.render(asteroidMap.scene, asteroidMap.camera); // Render CSS2D labels
        }

        // Start animation
        asteroidMap.animate();
        asteroidMapInitialized = true;
    }


    // --- Mitigation Map (impact.html) Logic ---
    let mitigationMapInitialized = false;
    let mitigationMapAnimationId; // To store the requestAnimationFrame ID

    function initMitigationMap() {
        // Clear previous Three.js objects and dispose resources if already initialized
        if (mitigationMapInitialized && window.mitigationMap && window.mitigationMap.scene) {
            window.mitigationMap.scene.children.forEach(child => {
                if (child.geometry) child.geometry.dispose();
                if (child.material) {
                    if (Array.isArray(child.material)) {
                        child.material.forEach(m => m.dispose());
                    } else {
                        child.material.dispose();
                    }
                }
                window.mitigationMap.scene.remove(child);
            });
            if (window.mitigationMap.renderer) window.mitigationMap.renderer.dispose();
            if (window.mitigationMap.controls) window.mitigationMap.controls.dispose();
            // Reset the flag and animation ID
            mitigationMapInitialized = false;
            if (typeof mitigationMapAnimationId !== 'undefined') {
                cancelAnimationFrame(mitigationMapAnimationId);
                mitigationMapAnimationId = undefined;
            }
        }

        const mitigationMap = {}; // Encapsulate all impact.html logic in this object
        window.mitigationMap = mitigationMap; // Make it globally accessible for cleanup

        // Modal functionality
        mitigationMap.helpBtn = document.getElementById('mitigation-map-help-btn');
        mitigationMap.helpModal = document.getElementById('mitigation-map-help-modal');
        mitigationMap.closeModal = document.getElementById('mitigation-map-close-modal');

        mitigationMap.helpBtn.addEventListener('click', () => {
            mitigationMap.helpModal.style.display = 'flex';
        });

        mitigationMap.closeModal.addEventListener('click', () => {
            mitigationMap.helpModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === mitigationMap.helpModal) {
                mitigationMap.helpModal.style.display = 'none';
            }
        });

        // Three.js Earth setup
        mitigationMap.scene = null;
        mitigationMap.camera = null;
        mitigationMap.renderer = null;
        mitigationMap.earth = null;
        mitigationMap.controls = null;
        mitigationMap.dangerZone = null;
        mitigationMap.dangerPin = null;
        mitigationMap.selectedAsteroid = null;

        mitigationMap.initEarth = function() {
            // Scene setup
            mitigationMap.scene = new THREE.Scene();
            
            // Camera setup
            mitigationMap.camera = new THREE.PerspectiveCamera(45, 
                document.getElementById('mitigation-map-earth-canvas').clientWidth / 
                document.getElementById('mitigation-map-earth-canvas').clientHeight, 
                0.1, 1000
            );
            mitigationMap.camera.position.z = 5;
            
            // Renderer setup
            const canvas = document.getElementById('mitigation-map-earth-canvas');
            mitigationMap.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            mitigationMap.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            canvas.appendChild(mitigationMap.renderer.domElement);
            
            // Earth geometry and material
            const geometry = new THREE.SphereGeometry(2, 64, 64);
            const textureLoader = new THREE.TextureLoader();
            
            // Use fallback textures if loading fails
            const earthTexture = textureLoader.load(
                'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg',
                undefined, // onLoad callback
                undefined, // onProgress callback
                (err) => {
                    console.error('Error loading Earth texture:', err);
                }
            );
            
            const material = new THREE.MeshPhongMaterial({
                map: earthTexture,
                specular: new THREE.Color(0x333333),
                shininess: 5
            });
            
            mitigationMap.earth = new THREE.Mesh(geometry, material);
            mitigationMap.scene.add(mitigationMap.earth);
            
            // Create danger zone (small red circle)
            const zoneGeometry = new THREE.CircleGeometry(0.2, 32);
            const zoneMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff0000, 
                transparent: true, 
                opacity: 0.3,
                side: THREE.DoubleSide
            });
            mitigationMap.dangerZone = new THREE.Mesh(zoneGeometry, zoneMaterial);
            mitigationMap.dangerZone.visible = false;
            mitigationMap.scene.add(mitigationMap.dangerZone);
            
            // Create danger pin (red marker)
            const pinGeometry = new THREE.ConeGeometry(0.05, 0.2, 8);
            const pinMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            mitigationMap.dangerPin = new THREE.Mesh(pinGeometry, pinMaterial);
            mitigationMap.dangerPin.visible = false;
            mitigationMap.scene.add(mitigationMap.dangerPin);
            
            // Add ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            mitigationMap.scene.add(ambientLight);
            
            // Add directional light (sun)
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 3, 5);
            mitigationMap.scene.add(directionalLight);
            
            // Add orbit controls
            mitigationMap.controls = new THREE.OrbitControls(mitigationMap.camera, mitigationMap.renderer.domElement);
            mitigationMap.controls.enableDamping = true;
            mitigationMap.controls.dampingFactor = 0.05;
            mitigationMap.controls.rotateSpeed = 0.5;
            
            // Handle window resize
            window.addEventListener('resize', mitigationMap.onWindowResize);
            
            // Start animation
            mitigationMap.animate();
        }

        mitigationMap.onWindowResize = function() {
            const canvas = document.getElementById('mitigation-map-earth-canvas');
            if (canvas && mitigationMap.camera && mitigationMap.renderer) {
                mitigationMap.camera.aspect = canvas.clientWidth / canvas.clientHeight;
                mitigationMap.camera.updateProjectionMatrix();
                mitigationMap.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            }
        }

        mitigationMap.animate = function() {
            mitigationMapAnimationId = requestAnimationFrame(mitigationMap.animate);
            if (mitigationMap.controls && mitigationMap.renderer && mitigationMap.scene && mitigationMap.camera) {
                mitigationMap.controls.update();
                mitigationMap.renderer.render(mitigationMap.scene, mitigationMap.camera);
            }
        }

        // Initialize Earth when the page loads
        mitigationMap.initEarth();

        // Current active asteroid for mitigation map
        mitigationMap.currentAsteroid = null;

        // Convert latitude/longitude to 3D position on sphere
        mitigationMap.latLongToVector3 = function(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            
            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = radius * Math.sin(phi) * Math.sin(theta);
            const y = radius * Math.cos(phi);
            
            return new THREE.Vector3(x, y, z);
        }

        // Show danger zone on Earth at specific coordinates
        mitigationMap.showDangerZone = function(lat, lon) {
            if (!mitigationMap.dangerZone || !mitigationMap.dangerPin) return;
            
            // Position danger zone and pin
            const position = mitigationMap.latLongToVector3(lat, lon, 2.01); 
            
            // Position the danger zone (small circle)
            mitigationMap.dangerZone.position.copy(position);
            mitigationMap.dangerZone.lookAt(new THREE.Vector3(0, 0, 0));
            mitigationMap.dangerZone.visible = true;
            
            // Position the danger pin
            mitigationMap.dangerPin.position.copy(position);
            mitigationMap.dangerPin.position.multiplyScalar(1.05); // Slightly above surface
            mitigationMap.dangerPin.lookAt(new THREE.Vector3(0, 0, 0));
            mitigationMap.dangerPin.visible = true;
        }

        // Hide danger zone
        mitigationMap.hideDangerZone = function() {
            if (mitigationMap.dangerZone && mitigationMap.dangerPin) {
                mitigationMap.dangerZone.visible = false;
                mitigationMap.dangerPin.visible = false;
            }
        }

        // Fetch asteroid data from NASA NeoWs API with fallback
        mitigationMap.fetchAsteroidData = async function() {
            const asteroidList = document.getElementById('mitigation-map-asteroid-list');
            asteroidList.innerHTML = '<li class="loading">Loading asteroid data...</li>';
            
            try {
                // Get today's date and 7 days from now for the API query
                const today = new Date();
                const nextWeek = new Date();
                nextWeek.setDate(today.getDate() + 7);
                
                const formatDate = (date) => {
                    return date.toISOString().split('T')[0];
                };
                
                const startDate = formatDate(today);
                const endDate = formatDate(nextWeek);
                
                // Try multiple API keys as fallback
                const apiKeys = [
                    'DEMO_KEY',
                    'N7LkblDsc5aen05FJqBQ8wU4qSdmsftjJagVK7UD', // Backup key 1
                    'DEMO_KEY' // Will use fallback data if this fails
                ];
                
                let data;
                let success = false;
                
                for (const apiKey of apiKeys) {
                    try {
                        const response = await fetch(`https://api.nasa.gov/neo/rest/v1/feed?start_date=${startDate}&end_date=${endDate}&api_key=${apiKey}`);
                        
                        if (response.ok) {
                            data = await response.json();
                            success = true;
                            break;
                        }
                    } catch (error) {
                        console.warn(`API key ${apiKey.substring(0, 5)}... failed:`, error);
                        // Continue to next API key
                    }
                }
                
                if (!success) {
                    // Use fallback data if API fails
                    data = mitigationMap.generateFallbackAsteroidData();
                }
                
                // Clear loading message
                asteroidList.innerHTML = '';
                
                // Process and display asteroid data
                let asteroids = [];
                
                // Extract asteroids from the response
                for (const date in data.near_earth_objects) {
                    asteroids = asteroids.concat(data.near_earth_objects[date]);
                }
                
                // Limit to 10 asteroids for display
                asteroids.slice(0, 10).forEach(asteroid => {
                    const listItem = document.createElement('li');
                    listItem.className = 'asteroid-item';
                    
                    // Extract close approach data
                    const closeApproach = asteroid.close_approach_data[0];
                    const velocity = Math.round(parseFloat(closeApproach.relative_velocity.kilometers_per_second));
                    const diameterMin = Math.round(asteroid.estimated_diameter.meters.estimated_diameter_min);
                    const diameterMax = Math.round(asteroid.estimated_diameter.meters.estimated_diameter_max);
                    
                    listItem.innerHTML = `
                        <div class="asteroid-name">${asteroid.name}</div>
                        <div class="asteroid-details">
                            Diameter: ${diameterMin} - ${diameterMax} m | 
                            Velocity: ${velocity} km/s
                        </div>
                        <div class="impact-coordinates">
                            Coordinates: <span>${mitigationMap.generateRandomCoordinates()}</span>
                        </div>
                    `;
                    
                    listItem.addEventListener('click', () => {
                        // Remove active class from all items
                        document.querySelectorAll('#mitigation-map-asteroid-list .asteroid-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Add active class to clicked item
                        listItem.classList.add('active');
                        
                        // Update impact scenarios
                        mitigationMap.updateImpactScenarios(asteroid);
                        
                        // Show danger zone on Earth
                        const coords = mitigationMap.extractCoordinates(listItem.querySelector('.impact-coordinates span').textContent);
                        mitigationMap.showDangerZone(coords.lat, coords.lon);
                        
                        // Store selected asteroid
                        mitigationMap.selectedAsteroid = asteroid;
                    });
                    
                    asteroidList.appendChild(listItem);
                });
                
            } catch (error) {
                console.error('Error fetching asteroid data:', error);
                asteroidList.innerHTML = `
                    <li class="error">
                        Failed to load asteroid data. 
                        <button class="retry-btn" onclick="mitigationMap.fetchAsteroidData()">Retry</button>
                    </li>
                `;
            }
        }

        // Generate fallback asteroid data if API fails
        mitigationMap.generateFallbackAsteroidData = function() {
            const asteroids = [];
            const names = [
                "2024 AB", "2024 AC", "2024 AD", "2024 AE", "2024 AF",
                "2024 AG", "2024 AH", "2024 AJ", "2024 AK", "2024 AL"
            ];
            
            for (let i = 0; i < 10; i++) {
                const diameter = Math.random() * 500 + 50;
                const velocity = Math.random() * 15 + 5;
                
                asteroids.push({
                    name: names[i],
                    estimated_diameter: {
                        meters: {
                            estimated_diameter_min: diameter * 0.8,
                            estimated_diameter_max: diameter * 1.2
                        }
                    },
                    close_approach_data: [{
                        relative_velocity: {
                            kilometers_per_second: velocity.toString()
                        },
                        miss_distance: {
                            kilometers: (Math.random() * 5000000 + 1000000).toString()
                        }
                    }]
                });
            }
            
            return {
                near_earth_objects: {
                    [new Date().toISOString().split('T')[0]]: asteroids
                }
            };
        }

        // Generate random coordinates for demonstration
        mitigationMap.generateRandomCoordinates = function() {
            const lat = (Math.random() * 180 - 90).toFixed(2);
            const lon = (Math.random() * 360 - 180).toFixed(2);
            const latDir = lat >= 0 ? 'N' : 'S';
            const lonDir = lon >= 0 ? 'E' : 'W';
            return `${Math.abs(lat)}${latDir}, ${Math.abs(lon)}${lonDir}`;
        }

        // Extract coordinates from string
        mitigationMap.extractCoordinates = function(coordString) {
            const parts = coordString.split(', ');
            const latPart = parts[0];
            const lonPart = parts[1];
            
            const lat = parseFloat(latPart.replace('N', '').replace('S', '')) * 
                       (latPart.includes('S') ? -1 : 1);
            const lon = parseFloat(lonPart.replace('E', '').replace('W', '')) * 
                       (lonPart.includes('W') ? -1 : 1);
            
            return { lat, lon };
        }

        // Generate impact scenario description based on NASA data
        mitigationMap.generateImpactScenario = function(asteroid) {
            const diameter = asteroid.estimated_diameter.meters.estimated_diameter_max;
            const velocity = parseFloat(asteroid.close_approach_data[0].relative_velocity.kilometers_per_second);
            const missDistance = parseFloat(asteroid.close_approach_data[0].miss_distance.kilometers);
            
            // Simplified calculations for demonstration purposes
            const mass = (4/3) * Math.PI * Math.pow(diameter / 2, 3) * 2500; // Assuming density of 2500 kg/m^3
            const energyJoules = 0.5 * mass * Math.pow(velocity * 1000, 2); // velocity in m/s
            const energyMegatons = energyJoules / (4.184 * Math.pow(10, 15)); // Convert Joules to Megatons of TNT

            let scenario = `<h3>Detailed Impact Scenario for ${asteroid.name}</h3>`;
            scenario += `<p><strong>Estimated Impact Energy:</strong> ${energyMegatons.toExponential(2)} Megatons of TNT</p>`;
            
            if (missDistance < 1000000) {
                scenario += "<p>This asteroid poses a significant threat due to its close approach distance. </p>";
            } else {
                scenario += "<p>While this asteroid is not an immediate threat, it warrants monitoring. </p>";
            }
            
            if (diameter > 5000) {
                scenario += "<p><strong>Global Catastrophe:</strong> An impact of this magnitude would trigger a global catastrophe. Expect widespread destruction, a potential impact winter, and long-term climate disruption. </p>";
                scenario += "<p><strong>Estimated Fatalities:</strong> Billions of lives could be lost due to immediate blast effects, tsunamis, and subsequent environmental collapse. </p>";
                scenario += "<p><strong>Affected Area:</strong> The immediate blast zone would span thousands of kilometers, with global atmospheric effects impacting the entire planet. </p>";
                scenario += "<p><strong>Tsunamis:</strong> Mega-tsunamis could devastate all coastal regions worldwide, potentially destroying hundreds of major cities. </p>";
                scenario += "<p><strong>Earthquake Magnitude:</strong> An earthquake of magnitude 10+ on the Richter scale would be generated, causing widespread structural collapse. </p>";
            } else if (diameter > 1000) {
                scenario += "<p><strong>Continental Devastation:</strong> This asteroid could cause devastation on a continental scale. Expect massive regional destruction, severe climate effects, and widespread loss of life. </p>";
                scenario += "<p><strong>Estimated Fatalities:</strong> Hundreds of millions to billions could perish. </p>";
                scenario += "<p><strong>Affected Area:</strong> The primary blast zone would cover hundreds of thousands of square kilometers, with significant environmental fallout across continents. </p>";
                scenario += "<p><strong>Tsunamis:</strong> Major tsunamis would impact entire ocean basins, capable of destroying dozens to hundreds of coastal cities. </p>";
                scenario += "<p><strong>Earthquake Magnitude:</strong> An earthquake of magnitude 9-10 on the Richter scale would be generated, causing severe damage over vast areas. </p>";
            } else if (diameter > 500) {
                scenario += "<p><strong>Regional Catastrophe:</strong> An impact would result in regional devastation. Significant cratering, widespread seismic activity, and substantial atmospheric effects are expected. </p>";
                scenario += "<p><strong>Estimated Fatalities:</strong> Tens of millions to hundreds of millions could be affected, with millions of direct fatalities. </p>";
                scenario += "<p><strong>Affected Area:</strong> The blast zone would cover an area equivalent to a large country, with severe damage extending for thousands of kilometers. </p>";
                scenario += "<p><strong>Tsunamis:</strong> If impacting an ocean, tsunamis could devastate coastal regions within a few thousand kilometers, potentially destroying several major cities. </p>";
                scenario += "<p><strong>Earthquake Magnitude:</strong> An earthquake of magnitude 8-9 on the Richter scale would be generated, causing widespread destruction. </p>";
            } else if (diameter > 100) {
                scenario += "<p><strong>Major Local Impact:</strong> Potential impacts could cause local to regional damage with notable blast effects and thermal radiation. </p>";
                scenario += "<p><strong>Estimated Fatalities:</strong> Hundreds of thousands to millions could be affected, with tens of thousands to hundreds of thousands of direct fatalities. </p>";
                scenario += "<p><strong>Affected Area:</strong> The blast zone would cover an area equivalent to a large metropolitan area, with significant damage extending for hundreds of kilometers. </p>";
                scenario += "<p><strong>Tsunamis:</strong> If impacting an ocean, localized tsunamis could affect nearby coastlines, potentially destroying a few smaller cities or towns. </p>";
                scenario += "<p><strong>Earthquake Magnitude:</strong> An earthquake of magnitude 7-8 on the Richter scale would be generated, causing significant local damage. </p>";
            } else if (diameter > 50) {
                scenario += "<p><strong>Significant Local Impact:</strong> This size asteroid would cause a significant local impact, likely an airburst or a small crater. </p>";
                scenario += "<p><strong>Estimated Fatalities:</strong> Thousands to tens of thousands could be affected, with hundreds to thousands of direct fatalities. </p>";
                scenario += "<p><strong>Affected Area:</strong> The blast zone would cover an area equivalent to a medium-sized city, with damage extending for tens of kilometers. </p>";
                scenario += "<p><strong>Tsunamis:</strong> If impacting an ocean, localized tsunamis could cause damage to immediate coastal areas. </p>";
                scenario += "<p><strong>Earthquake Magnitude:</strong> An earthquake of magnitude 6-7 on the Richter scale would be generated, causing moderate local damage. </p>";
            } else {
                scenario += "<p><strong>Minor Local Impact:</strong> Smaller impacts would primarily cause local damage with airburst effects, similar to the Chelyabinsk event. </p>";
                scenario += "<p><strong>Estimated Fatalities:</strong> Hundreds to thousands could be injured, with few direct fatalities. </p>";
                scenario += "<p><strong>Affected Area:</strong> The blast zone would cover a few square kilometers, with minor damage extending for a few kilometers. </p>";
                scenario += "<p><strong>Tsunamis:</strong> Negligible tsunami risk. </p>";
                scenario += "<p><strong>Earthquake Magnitude:</strong> An earthquake of magnitude 4-5 on the Richter scale would be generated, likely felt but causing minimal damage. </p>";
            }
            
            if (velocity > 20) {
                scenario += "<p>The high velocity significantly increases the kinetic energy and destructive potential. </p>";
            }
            
            scenario += "<p>Continuous monitoring and trajectory analysis are essential for accurate risk assessment.</p>";
            
            return scenario;
        }

        // Update impact scenarios based on selected asteroid
        mitigationMap.updateImpactScenarios = function(asteroid) {
            const scenariosContent = document.getElementById('mitigation-map-scenarios-content');
            scenariosContent.innerHTML = '';
            
            // Add scenario description from NASA data
            const descriptionElement = document.createElement('div');
            descriptionElement.className = 'scenario-description';
            descriptionElement.innerHTML = mitigationMap.generateImpactScenario(asteroid); // Use innerHTML for rich text
            scenariosContent.appendChild(descriptionElement);
            
            // Define hazards with conditions
            const hazards = [
                { emoji: '', text: 'Blast waves and overpressure', condition: true }, // Always a hazard
                { emoji: '', text: 'Thermal radiation', condition: true }, // Always a hazard
                { emoji: '', text: 'Cratering', condition: true }, // Always a hazard
                { emoji: '', text: 'Seismic shaking', condition: true }, // Always a hazard
                { emoji: '', text: 'Tsunami', condition: true }, // Always a hazard
                { emoji: '', text: 'Debris ejecta & atmospheric effects (blocking sunlight)', condition: true }, // Always a hazard
                { emoji: '', text: 'Cascading hazards', condition: true } // Always a hazard
            ];
            
            // Add hazards that meet conditions
            hazards.forEach(hazard => {
                if (hazard.condition) {
                    const hazardElement = document.createElement('div');
                    hazardElement.className = 'hazard-item';
                    hazardElement.innerHTML = `
                        <span class="hazard-emoji">${hazard.emoji}</span>
                        <span class="hazard-text">${hazard.text}</span>
                    `;
                    scenariosContent.appendChild(hazardElement);
                }
            });
            
            // If no hazards meet conditions, show a message
            if (scenariosContent.children.length === 1) { // Only the description
                const noHazardsElement = document.createElement('div');
                noHazardsElement.className = 'loading';
                noHazardsElement.textContent = 'This asteroid poses minimal impact risk';
                scenariosContent.appendChild(noHazardsElement);
            }
        }

        // Initialize the application
        mitigationMap.fetchAsteroidData();
        mitigationMapInitialized = true;
    }
  </script>

</body>
</html>
